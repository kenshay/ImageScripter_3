#!/usr/bin/env python3

import socket
from PyQt5 import QtGui,uic,QtCore
from win32api import GetSystemMetrics
import sys
from PyQt5.QtWidgets import QApplication, QWidget, QInputDialog, QLineEdit, QFileDialog
from PyQt5.QtWidgets import QApplication, QWidget, QInputDialog, QLineEdit, QFileDialog,QTextEdit,QMainWindow
import cv2
import win32api
from datetime import datetime as datetime1
import pickle
import cv2
from imagescripter.core.ssh_manager_for_image_show import SSH_Manager
from win32api import GetSystemMetrics
from imagescripter import *
from imagescripter.core.functions import Ping
import traceback
import win32api
import ctypes
from imagescripter.core.imagescripter_script import ImageScripter_Script_Class
from time import sleep
from datetime import datetime
import PyQt5
import time
from PyQt5.QtGui import QStandardItemModel,QStandardItem
from imagescripter.core.variable_file_getter import Variable_File_Getter
import os
from paths import *
import re
from PyQt5.QtCore    import *
from PyQt5.QtWidgets import *





class Server_Thread_Class(QThread):
    def __init__(self,parent):
        QThread.__init__(self)
        self.parent = parent

    def run(self):
        while True:
            try:
                import socket
                HOST = '127.0.0.1'
                PORT = 65432
                with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                    s.bind((HOST, PORT))
                    s.listen()
                    conn, addr = s.accept()
                    with conn:
                        print('Connected by', addr)
                        while True:
                            data = conn.recv(1024)
                            message = str(data.decode())
                            print(message)
                            self.parent.Create_and_Add_Post(message)
                            if not data:
                                break
                            conn.sendall(data)

            except Exception as e:
                    print(e)



class Dashboard_Class(QWidget):
    def __init__(self):
            QWidget.__init__(self)
            self.ui = uic.loadUi(r"C:\Eluminate\System\ImageScripter\Lib\site-packages\Dashboard\dashboard.ui")
            self.Server_Thread = Server_Thread_Class(self)
            self.Server_Thread.start()
            import socket
            IP = socket.gethostbyname(socket.gethostname())
            self.ui.ip_label.setText(str(IP))
            self.ui.show()


    def Create_and_Add_Post(self,text):
        try:
            cursor = self.ui.textBrowser.textCursor()
            cursor.movePosition(cursor.End)
            self.ui.textBrowser.append('<h1>' + text + '</h1')
            #cursor.insertText('1\n\n')
            self.ui.textBrowser.setTextCursor(cursor)
            self.ui.textBrowser.ensureCursorVisible()
            #self.ui.textBrowser.verticalScrollBar().setValue(self.ui.textBrowser.verticalScrollBar().maximum())
        except Exception as e:
            print(e)

app = QApplication(sys.argv)
ex = Dashboard_Class()
sys._excepthook = sys.excepthook
sys.exit(app.exec_())