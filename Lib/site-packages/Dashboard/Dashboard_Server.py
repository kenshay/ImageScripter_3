import socket
import sys
from _thread import start_new_thread
from paths import Dashboard_Server_IP
Path_for_Input = r"C:\Eluminate\System\ImageScripter\Lib\site-packages\Dashboard\Input.txt"
while True:
    print('Starting')
    HOST = Dashboard_Server_IP
    #HOST = '127.0.0.1'
    PORT = 65432

    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    except Exception as e:
        print(e)


    print("Socket Created")

    # bind socket
    try:
        s.bind((HOST, PORT))
        print("Socket Bound to port " + str(PORT))
        print('Socket Address is ' + HOST)
    except Exception as e:
        print(e)

    s.listen(10)
    print("Listening...")

    # The code below is what you're looking for ############

    def client_thread(Info):
        import os
        conn, addr = Info
        conn.send(b"Welcome to the Server. Type messages and press enter to send.\n")
        IP = str(addr[0])
        IP = IP = IP.replace('.','_')
        PORT = str(addr[1])
        os.chdir(r'C:\Eluminate\System\ImageScripter\Lib\site-packages\Dashboard\Connected_Controllers')
        with open(IP,'w') as f:
            f.write(IP + '__' + PORT)
        with open(r"C:\Eluminate\System\ImageScripter\Lib\site-packages\Dashboard\Connected_Controllers\update.txt",'w') as f:
            f.write('update')


        while True:
            data = conn.recv(1024)
            data = str(data.decode())
            #print(data)
            with open(Path_for_Input, 'w') as f:
                f.write(data)
            if not data:
                break
            reply = "OK . . " + data
            reply_in_bit = str.encode(reply)
            conn.sendall(reply_in_bit)
        conn.close()

    while True:
        # blocking call, waits to accept a connection
        conn, addr = s.accept()
        Info = [conn,addr]
        print("[-] Connected to " + addr[0] + ":" + str(addr[1]))

        start_new_thread(client_thread, (Info,))

    s.close()