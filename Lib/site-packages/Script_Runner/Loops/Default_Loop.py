from paths import *
from imagescripter import Itp12, Itp8, Itp8p
from imagescripter.core.image_manager import Image_Manager





def atoi(text):
    return int(text) if text.isdigit() else text
def natural_keys(text):
    import re
    return [atoi(c) for c in re.split('(\d+)', text)]





class Default_ScripRunner_Loop_Class():
    def __init__(self):
        self.Name = 'Default Loop'

    def get_list_of_all_folders(self):
        List_of_folders = []
        list_of_script_dict = self.get_list_of_script_dictionaries()
        for i in list_of_script_dict:
            directory_name = i['directory_name']
            List_of_folders.append(directory_name)
        set_of_folders = set(List_of_folders)
        List_of_folders = list(set_of_folders)
        return List_of_folders




    def get_list_of_script_dictionaries(self):
        import pickle
        import os
        List_of_Checked_Script_Dictionaries = []
        os.chdir(Script_Runner_Scripts_Folder)
        List_of_files = os.listdir()
        List_of_files.sort(key=natural_keys)
        for file_name in List_of_files:
            if "IGNORE" not in file_name:
                with open(file_name,'rb') as f:
                    script_dictionary = pickle.load(f)
                    if script_dictionary['wasSavedChecked'] == True:
                        List_of_Checked_Script_Dictionaries.append(script_dictionary)
            else:
                print("IGNORE -> ",file_name)

   

        return List_of_Checked_Script_Dictionaries

    def log_active_script(self,script_path):
        with open(Active_Script_For_Script_Runner, 'w') as f:
            f.write(script_path)

    def clear_text_editors(self):
        with open(clear_text_editors,'w') as f:
            f.write('True')


    def execute_git_pull(self):
        script = Reset_System_And_Project
        Image_Manager.replace_both_with_black()
        self.clear_script_writer_labels()
        import os
        import subprocess
        self.clear_text_editors()
        self.log_active_script(script)
        if os.system(Python_Exe_Location + ' -u ' + imagescripter_scriptpy) != 0:
            error_code = script + '--> Failed'
            raise Exception('Something Went Wrong')
        else:
            print("Script Passed")

    def execute_git_push(self):
        script = Save_System_And_Project
        Image_Manager.replace_both_with_black()
        self.clear_script_writer_labels()
        import os
        import subprocess
        self.clear_text_editors()
        self.log_active_script(script)
        if os.system(Python_Exe_Location + ' -u ' + imagescripter_scriptpy) != 0:
            error_code = script + '--> Failed'
            raise Exception('Something Went Wrong')
        else:
            print("Script Passed")

    def execute_script(self,script):
        Image_Manager.replace_both_with_black()
        self.clear_script_writer_labels()
        import os
        import subprocess
        self.clear_text_editors()
        self.log_active_script(script)
        if os.system(Python_Exe_Location + ' -u ' + imagescripter_scriptpy) != 0:
            error_code = script + '--> Failed'
            raise Exception('Something Went Wrong')
        else:
            print("Script Passed")

        #subprocess.call([Python_Exe_Location,'-u',imagescripter_scriptpy])
    def cmd_to_scripts_dictionary_folder(self):
        import os
        os.chdir(Script_Runner_Scripts_Folder)


    def print_traceback(self):
        import traceback
        trace = traceback.format_exc()
        print(trace)
        return traceback.format_exc()

    def Get_Controller_List_Of_Checked_Dictionaries(self):
        import pickle
        import os
        os.chdir(Script_Runner_Controllers_Folder)
        List_of_Checked_Controller_Dictionaries = []
        List_Of_Files = os.listdir(Script_Runner_Controllers_Folder)
        for file in List_Of_Files:
            with open(file, 'rb') as f:
                Controller_Dictionary = pickle.load(f)
                if Controller_Dictionary['wasSavedChecked'] == True:
                    List_of_Checked_Controller_Dictionaries.append(Controller_Dictionary)
        return List_of_Checked_Controller_Dictionaries

    def UpdateCycleCount(self):
        print('Updating Cycle Count')
        try:
            with open(Total_Runs_Script_Runnertxt, 'r') as f:
                scritp_runner_cycles = int(f.read())
            scritp_runner_cycles = scritp_runner_cycles + 1
            with open(Total_Runs_Script_Runnertxt, 'w') as f:
                f.write(str(scritp_runner_cycles))
        except Exception as e:
            print(e)
            with open(Total_Runs_Script_Runnertxt, 'w') as f:
                f.write('Error')

    def Do_Before_Loop_Prep(self):
        from imagescripter.core.functions import Clear_Directory_Contents
        Clear_Directory_Contents(Recordings_Location)
        Clear_Directory_Contents(Image_Compare_Location)




    def Do_Before_While_Loop_Prep(self):
        from imagescripter.core.functions import getListOfAllApplications
        from imagescripter.core.functions import MinizeAllApplications
        print('Running -> ',self.Name)
        self.List_of_opened_apps = getListOfAllApplications()
        self.List_Of_Checked_Controller_Dictionaries = self.Get_Controller_List_Of_Checked_Dictionaries()
        #MinizeAllApplications()

    def Do_After_Failure_Post(self):
        try:
            with open(Stop_on_Fail_radio_button_file_state_location,'r') as f:
                Bool = eval(f.read())
        except:
            with open(Stop_on_Fail_radio_button_file_state_location, 'w') as f:
                f.write('False')
            Bool = False
        if Bool == True:
            raise
        else:
            pass
        from imagescripter.core.functions import closeAllApplicationsNotInList
        closeAllApplicationsNotInList(self.List_of_opened_apps)
        self.print_traceback()

    def clear_script_writer_labels(self):
        try:
            with open(Clear_File_Script_Writer,'w') as f:
                f.write("True")
        except Exception as e:
            print(e)
            pass


    def Update_Controller_settings_files_with_Dictionary(self,Controller_Dict):
        print("Update Controller settings files with Dictionary")
        #{'name': 'frank2', 'password': 'stein', 'ip': '192.168.0.121', 'type': 'SC100', 'wasSavedChecked': True,
        # 'path': 'C:\\Eluminate\\Projects\\_elan_\\Settings\\ScriptRunner_Controllers\\frank2'}
        Controller_Nametxt = Settings_Location + r"Controller_Name.txt"  #
        Controller_IPtxt = Settings_Location + r"Controller_IP.txt"  #
        Controller_Type_Location = Settings_Location + r"Controller_Type.txt"
        Controller_Passwordtext = Settings_Location + r"Controller_Password.txt"


        name = Controller_Dict['name']
        print('Writing Controller Name -> ',name)
        with open(Controller_Nametxt,'w') as f:
            f.write(name)

        password = Controller_Dict['password']
        print('Writing Controller Password -> ',password)
        with open(Controller_Passwordtext,'w') as f:
            f.write(password)

        ip = Controller_Dict['ip']
        print('Writing Controller IP -> ', ip)
        with open(Controller_IPtxt,'w') as f:
            f.write(ip)

        type = Controller_Dict['type']
        print('Writing Controller Tyoe -> ', type)
        with open(Controller_Type_Location,'w') as f:
            f.write(type)

    def Update_Inteface_Connection_Files(self):
        print("Updating inteface's connection files")
        Itp12.Connect()
        Itp8.Connect()
        Itp8p.Connect(portait = True)


    def run(self):
        self.Do_Before_While_Loop_Prep()
        while True:
            self.Do_Before_Loop_Prep()
            for Controller_Dict in self.List_Of_Checked_Controller_Dictionaries:
                ############################################################################
                if Git_Sync == True:
                    try:
                        self.execute_git_push()
                        self.execute_git_pull()
                    except:
                        self.Do_After_Failure_Post()
                else:
                    print("Auto Git Has Been Turned Off")
                ############################################################################

                self.Update_Controller_settings_files_with_Dictionary(Controller_Dict)
                self.Update_Inteface_Connection_Files()

                for Script_Dictionary in self.get_list_of_script_dictionaries():
                    try:
                        self.script_path = Script_Dictionary['path']
                        self.execute_script(self.script_path)
                    except:
                        self.Do_After_Failure_Post()
                self.UpdateCycleCount()



if __name__ == '__main__':
    import time

    Loop = Default_ScripRunner_Loop_Class()
    Loop.run()

    #Loop.Do_Before_While_Loop_Prep()
    #from imagescripter import Sleep
    #Sleep(20)
    #from imagescripter.core.functions import closeAllApplicationsNotInList
    #closeAllApplicationsNotInList(Loop.List_of_opened_apps)


    #Loop.run()