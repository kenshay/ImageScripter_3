from PyQt5 import QtGui,uic,QtCore
from win32api import GetSystemMetrics
import sys
from PyQt5.QtWidgets import QApplication, QWidget, QInputDialog, QLineEdit, QFileDialog
import cv2
import win32api
from time import sleep
from datetime import datetime
import PyQt5
import time
from PyQt5.QtGui import QStandardItemModel,QStandardItem
from imagescripter.core.variable_file_getter import Variable_File_Getter
import os
from paths import *
import re
from PyQt5.QtCore    import *
from PyQt5.QtWidgets import *

def atoi(text):
    return int(text) if text.isdigit() else text
def natural_keys(text):
    return [atoi(c) for c in re.split('(\d+)', text)]

class Custom_StandardItem_Class(QStandardItem):
    def __init__(self,text = ''):
        super().__init__()
        self.setText(text)
        self.Index_Time_String = None

class Custom_Checkbox_Class(QCheckBox):
    def __init__(self,text = ''):
        super().__init__()
        self.setText(text)
        self.Index_Time_String = None


class Script_Runner_Gui_Class(QWidget):
    def __init__(self):
            QWidget.__init__(self)
            self.ui = uic.loadUi(ImageScripter_Location + "Lib\site-packages\Script_Runner\script_runner_gui.ui")
            self.generate_controller_selection_list()
            self.generate_folder_selection_list()
            self.generate_scripts_selection_list()
            self.generate_play_list()
            self.ui.show()

    def generate_controller_selection_list(self):
        self.List_Of_Controlelrs = ['frank2','TestSC']
        for controller in self.List_Of_Controlelrs:
            self.checkbox = Custom_Checkbox_Class(controller)
            self.ui.verticalLayout_11.addWidget(self.checkbox)

    def generate_folder_selection_list(self):
        self.List_Of_Script_Folders = eval(Variable_File_Getter.getVariableFromFile('Active_Script_Folder'))
        for folder in self.List_Of_Script_Folders:
            self.checkbox = Custom_Checkbox_Class(folder)
            self.ui.verticalLayout_13.addWidget(self.checkbox)

    def generate_scripts_selection_list(self):
            for folder in self.List_Of_Script_Folders:
                print(folder)
                os.chdir(folder)
                List = os.listdir(folder)
                # print(List)
                List.sort(key=natural_keys)
                for i in List:

                    if i.endswith('.py'):
                        #if "IGNORE" not in i:
                            print(i)
                            self.checkbox = Custom_Checkbox_Class(os.path.abspath(i))
                            self.ui.verticalLayout_15.addWidget(self.checkbox)

    def generate_play_list(self):
            for folder in self.List_Of_Script_Folders:
                os.chdir(folder)
                List = os.listdir(folder)
                # print(List)
                List.sort(key=natural_keys)
                for i in List:
                    if i.endswith('.py'):
                        if "IGNORE" not in i:
                            self.checkbox = Custom_Checkbox_Class(os.path.abspath(i))
                            self.ui.verticalLayout_16.addWidget(self.checkbox)



    def populate_list_box(self):
        Script_Folder_List = eval(Variable_File_Getter.getVariableFromFile('Active_Script_Folder'))
        for folder in Script_Folder_List:
            os.chdir(folder)
            List = os.listdir(folder)
            #print(List)
            List.sort(key=natural_keys)
            for i in List:
                if i.endswith('.py'):
                    if "IGNORE" not in i:
                        print(i)
                        script_location = os.path.abspath(i)
                        print('#########')
                        print(script_location)
                        print('#########')
                        script_object = ImageScripter_Script_Class(script_location)
                        List_of_scripts.append(script_object)
                    else:
                        print("IGNORE -> ", i)






if __name__ == '__main__':
        app = QApplication(sys.argv)
        ex = Script_Runner_Gui_Class()
        sys._excepthook = sys.excepthook

        def exception_hook(exctype, value, traceback):
            print(exctype, value, traceback)
            sys._excepthook(exctype, value, traceback)
            sys.exit(1)
        sys.excepthook = exception_hook
        sys.exit(app.exec_())




