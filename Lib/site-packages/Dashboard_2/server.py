import socket
from PyQt5 import QtGui,uic,QtCore
import random
from win32api import GetSystemMetrics
import sys
from PyQt5.QtWidgets import QApplication, QWidget, QInputDialog, QLineEdit, QFileDialog
from PyQt5.QtWidgets import QApplication, QWidget, QInputDialog, QLineEdit, QFileDialog,QTextEdit,QMainWindow
import cv2
import win32api
from datetime import datetime as datetime1
import pickle
import cv2
from win32api import GetSystemMetrics
import traceback
import win32api
import ctypes
from time import sleep
from datetime import datetime
import PyQt5
import time
from PyQt5.QtGui import QStandardItemModel,QStandardItem
import os
from paths import *
import re
from PyQt5.QtCore    import *
from PyQt5.QtWidgets import *
import sys
import socket
import sys
from _thread import start_new_thread
from paths import Dashboard_Server_IP,Dashboard_Server_PORT
import os
import traceback


class Client_Thread_Class(QThread):
    def __init__(self,parent,Info):
        QThread.__init__(self)
        self.parent = parent
        self.Info = Info
        self.conn,self.addr = self.Info
        self.IP = str(self.addr[0])
        self.PORT = str(self.addr[1])
        self.Id = self.IP + ':' + self.PORT
        self.Client_Tracker = self.parent.Client_Tracker


    def Update_All_Labels(self):
        self.Client_Widget.ui.station_name_label.setText(self.station_name)
        self.Client_Widget.ui.controllerNameLineEdit.setText(self.controller_name)
        self.Client_Widget.ui.scriptNameLineEdit.setText(self.script_name)
        self.Client_Widget.ui.controllerBuildLineEdit.setText(self.controller_build)
        self.Client_Widget.ui.controllerIPLineEdit.setText(self.controller_ip)
        self.Client_Widget.ui.cPUUSageLineEdit.setText(self.cpu_usage)
        self.Client_Widget.ui.memoryFreeLineEdit.setText(self.memory_free)
        self.Client_Widget.ui.memoryUsedLineEdit.setText(self.memory_used)
        self.Client_Widget.ui.driveSpaceUsedLineEdit.setText(self.drive_space_used)
        self.Client_Widget.ui.sSHConnectionsLineEdit.setText(self.ssh_connections)
        self.Client_Widget.ui.cycleLineEdit.setText(self.cycle)
        self.Client_Widget.ui.timeLineEdit.setText(self.time)
        self.Client_Widget.ui.dateLineEdit.setText(self.date)




    def Unpack_Info_Dictionary_Into_Variables(self):
        self.controller_name = self.Info_Dictionary['controller_name']
        self.station_name = self.Info_Dictionary['station_name']
        self.script_name = self.Info_Dictionary['script_name']
        self.template = self.Info_Dictionary['template']
        self.target = self.Info_Dictionary['target']
        self.desktop_picture = self.Info_Dictionary['desktop_picture']
        self.controller_build = self.Info_Dictionary['controller_build']
        self.controller_ip = self.Info_Dictionary['controller_ip']
        self.cpu_usage = self.Info_Dictionary['cpu_usage']
        self.memory_free = self.Info_Dictionary['memory_free']
        self.memory_used = self.Info_Dictionary['memory_used']
        self.drive_space_used = self.Info_Dictionary['drive_space_used']
        self.ssh_connections = self.Info_Dictionary['ssh_connections']
        self.cycle = self.Info_Dictionary['cycle']
        self.time = self.Info_Dictionary['time']
        self.date = self.Info_Dictionary['date']


    def Update_Template(self):
        int1 = str(random.randint(1, 999999))
        file_name = r"C:\Users\ken.shay\Desktop\\" + int1 + '.png'
        with open(file_name, 'wb') as f:
            f.write(self.template)
        self.Pixmap = QtGui.QPixmap(file_name)
        Width = self.Client_Widget.ui.template_label.frameGeometry().width()
        #Width = self.Client_Widget.ui.frameGeometry().width()
        Height = self.Client_Widget.ui.template_label.frameGeometry().height()
        #Height = self.Client_Widget.ui.frameGeometry().height()
        self.Pixmap = self.Pixmap.scaled(Width, Height, QtCore.Qt.KeepAspectRatio)
        os.remove(file_name)
        self.Client_Widget.ui.template_label.setPixmap(self.Pixmap)



    def Update_Desktop_Picture(self):
        int1 = str(random.randint(1, 999999))
        file_name = r"C:\Users\ken.shay\Desktop\\" + int1 + '.png'
        with open(file_name, 'wb') as f:
            f.write(self.desktop_picture)
        self.Pixmap = QtGui.QPixmap(file_name)
        Width = self.Client_Widget.ui.desktop_picture.frameGeometry().width()
        #Width = self.Client_Widget.ui.frameGeometry().width()
        Height = self.Client_Widget.ui.desktop_picture.frameGeometry().height()
        #Height = self.Client_Widget.ui.frameGeometry().height()
        self.Pixmap = self.Pixmap.scaled(Width, Height, QtCore.Qt.KeepAspectRatio)
        os.remove(file_name)
        self.Client_Widget.ui.desktop_picture.setPixmap(self.Pixmap)







    def Update_Target(self):
        int1 = str(random.randint(1, 999999))
        file_name = r"C:\Users\ken.shay\Desktop\\" + int1 + '.png'
        with open(file_name, 'wb') as f:
            f.write(self.target)
        self.Pixmap = QtGui.QPixmap(file_name)
        Width = self.Client_Widget.ui.target_label.frameGeometry().width()
        #Width = self.Client_Widget.ui.frameGeometry().width()
        Height = self.Client_Widget.ui.target_label.frameGeometry().height()
        #Height = self.Client_Widget.ui.frameGeometry().height()
        self.Pixmap = self.Pixmap.scaled(Width, Height, QtCore.Qt.KeepAspectRatio)
        os.remove(file_name)
        self.Client_Widget.ui.target_label.setPixmap(self.Pixmap)



    def run(self):
        try:
            print('Thread Created With ', self.IP, ' : ', self.PORT)
            while True:
                try:
                    whole = b''
                    while True:
                        chunk = self.conn.recv(10000)
                        whole += chunk
                        try:
                            self.Client_Widget = self.Client_Tracker.getWidget(self.Id)
                            self.Info_Dictionary = pickle.loads(whole)
                            self.Unpack_Info_Dictionary_Into_Variables()
                            self.Update_Template()
                            self.Update_Target()
                            self.Update_Desktop_Picture()
                            self.Update_All_Labels()

                            break
                        except Exception as e:
                            if str(e) == 'pickle data was truncated':
                                pass
                            else:
                                traceback.print_exc()
                                print(e)
                except Exception as e:

                    traceback.print_exc()
                    try:
                        self.conn.close()
                    except Exception as e:
                        traceback.print_exc()
                    break
        except Exception as e:
            traceback.print_exc()
            try:
                self.conn.close()
            except Exception as e:
                traceback.print_exc()



class Listener_Thread_Class(QThread):
    def __init__(self,parent):
        QThread.__init__(self)
        self.parent = parent

    def run(self):
        try:
            while True:
                print('Starting Server')
                HOST = Dashboard_Server_IP
                socket_connection = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                socket_connection.bind((HOST, Dashboard_Server_PORT))
                print('Created Socket ', HOST, ' : ', Dashboard_Server_PORT)
                socket_connection.listen(10)
                while True:
                    conn, addr = socket_connection.accept()
                    IP,Port = addr
                    Info_Dictionary = dict([('ip',IP),('port',Port)])
                    Info = [conn, addr]
                    self.parent.emit_add_client_signal(Info_Dictionary)
                    self.Client_Thread = Client_Thread_Class(self.parent,Info)
                    self.Client_Thread.start()
                    #start_new_thread(client_thread, (Info,))
                socket_connection.close()
        except Exception as e:
            traceback.print_exc()


class Client_Tracker_Class():
    def __init__(self,parent):
        self.parent = parent
        self.list_of_clients = []

    def getCount(self):
        return len(self.list_of_clients)

    def addWidget(self,widget):
        self.list_of_clients.append(widget)

    def getWidget(self,id):
        for client in self.list_of_clients:
            if client.id == id:
                return client
        return self.list_of_clients[0]



class Client_Widget_Class(QWidget):
  def __init__( self, parent,Selected_Connection_Info_Dictionary):
      super(Client_Widget_Class, self).__init__(parent)
      self.ui = uic.loadUi(r"C:\Eluminate\System\ImageScripter\Lib\site-packages\Dashboard_2\client_widget.ui",self)
      self.Selected_Connection_Info_Dictionary = Selected_Connection_Info_Dictionary
      self.id = self.Selected_Connection_Info_Dictionary.get("ip") + ':' + str(self.Selected_Connection_Info_Dictionary.get("port"))
      self.ui.switch_ui_button.clicked.connect(self.switch_to_show_info)
      self.ui.stackedWidget.setCurrentIndex(0)
  def switch_to_show_info(self):
      try:
          if self.ui.stackedWidget.currentIndex() == 0:
            self.ui.stackedWidget.setCurrentIndex(1)
          else:
            self.ui.stackedWidget.setCurrentIndex(0)
      except Exception as e:
          traceback.print_exc()





class Dashboard_Class(QWidget):
    def __init__(self):
            QWidget.__init__(self)
            self.ui = uic.loadUi(r"C:\Eluminate\System\ImageScripter\Lib\site-packages\Dashboard_2\dashboard.ui")
            self.Client_Tracker = Client_Tracker_Class(self)
            Listener_Thread = Listener_Thread_Class(self)
            Listener_Thread.start()
            self.Selected_Connection_Info_Dictionary = None
            self.init_hidden_new_client_trigger_button()
            self.ui.showMaximized()


    def init_hidden_new_client_trigger_button(self):
        try:
            self.hidden_add_new_client_trigger = QPushButton('add new client')
            self.hidden_add_new_client_trigger.clicked.connect(self.add_new_client_connection_with_emit_signal)
            self.hidden_add_new_client_trigger.hide()
        except Exception as e:
            traceback.print_exc()



    def emit_add_client_signal(self,Info_Dictionary):
        try:
            self.Selected_Connection_Info_Dictionary = Info_Dictionary
            self.hidden_add_new_client_trigger.click()
        except Exception as e:
            traceback.print_exc()

    def add_new_client_connection_with_emit_signal(self):
        try:
            Selected_Connection_Info_Dictionary = self.Selected_Connection_Info_Dictionary
            self.Selected_Connection_Info_Dictionary = None
            self.New_Client_Widget = Client_Widget_Class(self,Selected_Connection_Info_Dictionary)
            self.Client_Tracker.addWidget(self.New_Client_Widget)
            print('Client Count = ',self.Client_Tracker.getCount())
            if self.Client_Tracker.getCount() == 0:
                self.ui.gridLayout.addWidget(self.New_Client_Widget)
            elif self.Client_Tracker.getCount() == 1:
                self.ui.gridLayout.addWidget(self.New_Client_Widget,0,1)
            elif self.Client_Tracker.getCount() == 2:
                self.ui.gridLayout.addWidget(self.New_Client_Widget,0,2)
            elif self.Client_Tracker.getCount() == 3:
                self.ui.gridLayout.addWidget(self.New_Client_Widget,1,1)
            elif self.Client_Tracker.getCount() == 4:
                self.ui.gridLayout.addWidget(self.New_Client_Widget,1,2)
            elif self.Client_Tracker.getCount() == 5:
                self.ui.gridLayout.addWidget(self.New_Client_Widget,2,1)
            elif self.Client_Tracker.getCount() == 6:
                self.ui.gridLayout.addWidget(self.New_Client_Widget, 2, 2)
            elif self.Client_Tracker.getCount() == 7:
                self.ui.gridLayout.addWidget(self.New_Client_Widget, 3, 1)
            elif self.Client_Tracker.getCount() == 8:
                self.ui.gridLayout.addWidget(self.New_Client_Widget, 3, 2)
            else:
                self.ui.gridLayout.addWidget(self.New_Client_Widget)
        except Exception as e:
            traceback.print_exc()





app = QApplication(sys.argv)
ex = Dashboard_Class()
sys._excepthook = sys.excepthook
sys.exit(app.exec_())