from yattag import Doc
from yattag import indent
import random
import os
from Database_Manager.Dictionary_Database_Manager import Dictionary_Database_Manager_Class
from paths import Dictionary_Database_Location,All_Scripts_Folder_Location,Active_Build,Graph_Folder_Location,Active_Build_without_EXE
####################################################################
Script_Amount = 94
Cycle_Time = '0:04:27'
Station_Name = 'FrankPC_Station'

Dictionary_Database_Manager = Dictionary_Database_Manager_Class(Dictionary_Database_Location)


Stations_List = Dictionary_Database_Manager.get_all_station_names()
Stations_List = set(Stations_List)
Stations_List = list(Stations_List)
List_of_scripts_dicts = []
Max_Length_List = []

##################################################################
##################################################################
doc, tag, text = Doc().tagtext()

doc.asis('<!DOCTYPE HTML>')
with tag('html', lang=" en"):
    with tag('head'):
        doc.asis('<!-- basic.html -->')
        with tag('title'):
            text('basic.html')
        doc.asis('<meta charset = "UTF-8" />')
        doc.asis('<link rel="stylesheet" href="style.css">')
    with tag('body'):
        with tag('h1'):
            Active_Build = Active_Build_without_EXE.replace('_','.')
            Active_Build = "Build = " + Active_Build

            text(Active_Build)




        with tag('div'):
            for Station_Name in sorted(Stations_List):
                scripts_list = Dictionary_Database_Manager.get_all_scripts_from_station(Station_Name)
                for script_name in reversed(scripts_list):
                    Pass_Fail_List_of_entries_for_script = Dictionary_Database_Manager.get_order_of_happened_scripts_passes_and_fails(Station_Name, script_name)
                    Max_Length_List.append(len(Pass_Fail_List_of_entries_for_script))
                    script_dict = {}
                    script_dict['name'] = script_name
                    List = []
                    for entry in Pass_Fail_List_of_entries_for_script:
                        Result_Dict = {}
                        Result_Dict['pass'] = entry['pass'].split(':')[1]
                        fail_Video_Name = entry['fail_video'].split(':')[1]
                        fail_Video_Name = os.path.basename(fail_Video_Name)
                        fail_Video_Name_without_avi = fail_Video_Name.rstrip('.avi')
                        Result_Dict['fail_Video_Name_without_avi'] = fail_Video_Name_without_avi
                        List.append(Result_Dict)
                    script_dict['results'] = List
                    List_of_scripts_dicts.append(script_dict)
                Amount_Of_Runs_Total = max(Max_Length_List)
                with tag('table',id="title_table"):
                            with tag('tr'):
                                with tag('td',id="title_table_td"):
                                    #astring = 'Build = $'
                                    #astring = astring.replace('$',str(Active_Build))
                                    #text(astring)
                                    #text(' ')
                                    text(Station_Name)
                with tag('table', cellspacing="0",cellpadding="0"):
                ###################################################################################
                            with tag('tr'):
                                with tag('td', id="td_script_name"):
                                    pass
                                for interger in range(Amount_Of_Runs_Total):
                                    interger += 1
                                    with tag('td', id="td_script_number"):
                                        text(str(interger))
                #################################################################################

                                for script_dict in List_of_scripts_dicts:
                                     name = script_dict['name']
                                     Result_Dict_List = script_dict['results']
                                     with tag('tr'):
                                        with tag('td',id="td_script_name"):
                                            text(name)
                                        for Result_Dict in Result_Dict_List:
                                            pass_or_fail = Result_Dict['pass']
                                            print(pass_or_fail)
                                            if pass_or_fail == 'True':
                                                pass_or_fail = 'tdpass'
                                            else:
                                                pass_or_fail = 'tdfail'
                                            fail_Video_Name_without_avi = Result_Dict['fail_Video_Name_without_avi']
                                            if fail_Video_Name_without_avi != 'None':
                                                linkwhole = "location.href='http://172.105.150.15/fails/" + fail_Video_Name_without_avi + "/fail.php'"
                                                print(linkwhole)
                                                with tag('td',id=pass_or_fail,onclick=linkwhole):
                                                    pass
                                            else:
                                                with tag('td', id=pass_or_fail):
                                                    pass
                                        for blank in range(Amount_Of_Runs_Total - len(Result_Dict_List)):
                                            with tag('td', id='tdnotrun'):
                                                pass
                                ###################################################################################
                                with tag('tr'):
                                    with tag('td', id="td_script_name"):
                                        pass
                                    for interger in range(Amount_Of_Runs_Total):
                                        interger += 1
                                        with tag('td', id="td_script_number"):
                                            text(str(interger))
                                #################################################################################



result = indent(doc.getvalue())

print(result)
with open(r"C:\xampp\htdocs\index.php",'w') as f:
    f.write(result)


