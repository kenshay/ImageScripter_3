from paramiko import SSHClient
from scp import SCPClient
import logging
import paramiko
import os
from paths import Active_Build_without_EXE,Controler_Build_Location,Videos_For_Database_Location
Active_Build_without_EXE = Active_Build_without_EXE.replace('_','.')
print(Active_Build_without_EXE)
import traceback
import time

def Sleep(sec):
    for i in range(sec):
        print(i,' ', sec)
        time.sleep(1)


ssh_host = '172.105.150.15'
ssh_user = 'root'
ssh_password = 'M8wh11YhL'
ssh_port = '22'


try:
    os.listdir(Videos_For_Database_Location)
    source_volume = Videos_For_Database_Location
except Exception as e:
    print(e)
    source_volume = r"C:\Users\ken.shay\Desktop\videos"
destination_volume = r"/var/www/html/videos"



os.listdir(Controler_Build_Location)[0]

def Upload_Videos():
    try:
        Active_Build = os.listdir(Controler_Build_Location)[0]
    except FileNotFoundError:
        Active_Build = '8_4_88_1.EXE'


    Active_Build_without_EXE = Active_Build.split('.')[0]
    Active_Build_without_EXE = Active_Build_without_EXE.replace('_', '.')
    print('##########################################')
    print('##########################################')
    print('Active Build Is -> ',Active_Build)
    print('Source Folder Is -> ',source_volume)
    print('##########################################')
    print('##########################################')

    os.chdir(source_volume)
    New_List_of_videos = os.listdir()
    Already_Uploaded_Files = Get_Already_Uploaded_Files()
    ssh = SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(ssh_host, username=ssh_user, password=ssh_password, look_for_keys=False)
    with SCPClient(ssh.get_transport()) as scp:
        for video in New_List_of_videos:
            if Active_Build_without_EXE in video:
                if video not in Already_Uploaded_Files:
                    if '__Fail__' in video:
                        print('Uploading -> ',video)
                        Dest = destination_volume + '/' + video
                        print('Destination -> ',Dest)
                        scp.put(video,Dest)
                else:
                    print('Skipping Already Updated -> ',video)
            else:
                print('Skipping Not Current Active Build -> ', video)
    ssh.close()
    scp.close()

        #scp.put(source_volume, recursive=True, remote_path=destination_volume)



def Get_Already_Uploaded_Files():
    print("Get_Already_Uploaded_Files")
    ssh = SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(ssh_host, username=ssh_user, password=ssh_password, look_for_keys=False)
    sftp = ssh.open_sftp()
    List_Of_Already_Uploaded_Videos = []
    for filename in sftp.listdir(destination_volume):
        List_Of_Already_Uploaded_Videos.append(filename)
    return List_Of_Already_Uploaded_Videos
    ssh.close()
    sftp.close()



x = 0
while True:
    while True:
        print('##########Loop -> ',x)
        x += 1
        print("Starting Loop")
        try:
            Upload_Videos()
        except:
            traceback.print_exc()
        print("Finished Loop")
        Sleep(60)