import sys
from PyQt5.QtWidgets import QApplication, QWidget
from win32api import GetSystemMetrics
from PyQt5.QtGui import QIcon
from PyQt5.QtWidgets import QApplication, QWidget, QInputDialog, QLineEdit, QFileDialog
from PyQt5.QtWidgets import QApplication, QWidget, QPushButton, QMessageBox
from PyQt5 import QtGui, uic, Qt
from PyQt5.QtGui import QStandardItemModel,QStandardItem
import traceback
import subprocess
from variable_file_getter import Variable_File_Getter
import os
from PyQt5.QtGui import QIcon, QPixmap
import base64
import sys
from PIL import Image
from PyQt5.QtGui import *
from PyQt5.QtWidgets import *
from PyQt5.QtCore import *
from Script_Writer.editor import Editor_Class
from Script_Writer.snipping_tool import Snipping_Tool_Class
import paramiko
from scp import SCPClient

import shutil
import PyQt5
from win32api import GetSystemMetrics
from PyQt5 import QtCore
import win32api

def GetSecondDisplyRect():
    secondMonort = None
    monitors = win32api.EnumDisplayMonitors()
    for i in monitors:
        a = win32api.GetMonitorInfo(i[0])
        if a['Flags'] == 0:
            x,y,w,h = a['Monitor']
            w = x - w
            h = y - h
            w = -w
            h = -h
            print(x,y,w,h)
            return x,y,w,h


class Script_Writer_Class(QWidget):

    def __init__(self,app):
        super().__init__()
        #self.ui = uic.loadUi(r"database_viewer.ui")
        self.app = app
        self.ui = uic.loadUi(r"C:\ImageScripter_2\Lib\site-packages\Script_Writer\script_writer.ui")
        self.editor = Editor_Class()
        self.ui.setWindowTitle("Script Writer")
        self.ui.horizontalLayout.addWidget(self.editor)
        self.last_opened_file = None
        self.ui.label.setText("")
        self.ui.pushButton_4.clicked.connect(self.capture_button_clicked)
        self.ui.pushButton_3.clicked.connect(self.getITP8_Image_was_clicked)
        self.ui.pushButton_6.clicked.connect(self.run_was_clicked)
        self.ui.pushButton_7.clicked.connect(self.stop_was_clicked)
        self.ui.actionOpen.triggered.connect(self.open_clicked)
        self.ui.actionSave.triggered.connect(self.Save_clicked)
        self.ui.actionSave_As.triggered.connect(self.Save_As_clicked)
        self.ui.actionNew.triggered.connect(self.New_was_clicked)
        self.ui.actionRun_Script.triggered.connect(self.run_was_clicked)
        self.ui.actionClose.triggered.connect(self.Close_clicked)
        #self.ui.show()
        #self.ui.showMaximized()
        if PyQt5.QtWidgets.QDesktopWidget().screenCount() == 2:
            x, y, w, h = GetSecondDisplyRect()
            self.ui.setGeometry(x, y, w, h)
            self.ui.showMaximized()
        if PyQt5.QtWidgets.QDesktopWidget().screenCount() >= 3:
            raise ValueError("Too many screens Connected, MAX 2")
        else:
            self.ui.showMaximized()



    def p(self,x):
        print(x)
        self.ui.pushButton_7.setEnabled(True)
        self.ui.pushButton_6.setEnabled(False)

    def p1(self,x):
        print(x)
        self.ui.pushButton_7.setChecked(False)
        self.ui.pushButton_7.setEnabled(False)
        self.ui.pushButton_6.setEnabled(True)











    def New_was_clicked(self):
        self.editor.setText('')
        self.ui.label.setText("")
        self.last_opened_file = None



    def stop_was_clicked(self):
        try:
            self.process.terminate()
            self.process.kill()
            self.process.close()

            self.append('Script Stopped')
        except Exception as e:

            self.append('Script Stopped')
            print(e)
        #self.process = QtCore.QProcess(self)
        #self.process.readyReadStandardOutput.connect(self.stdoutReady)
        #self.process.readyReadStandardError.connect(self.stderrReady)
        #self.process.started.connect(lambda: p('Started!'))
        #self.process.finished.connect(lambda: p('Finished!'))
        #print('Starting process')
        #self.process.start(r'C:\ImageScripter_2\python.exe', [r"C:\Users\Automation3\Desktop\test.py"])

    def keyPressEvent(self, ev):
        print("key press")





    def run_was_clicked(self):

        print('Run was Clicked')
        self.ui.textEdit.setText('Running Script...\n')
        import time
        #time.sleep(5)
        text  = 'from elan import *\n'
        text = text + self.editor.text()
        with open(r"C:\Users\Automation3\Desktop\test.py",'w') as f:
            f.write(text)
        #self.ui.textEdit.setText('')
        self.process = QtCore.QProcess(self)
        self.process.readyReadStandardOutput.connect(self.stdoutReady)
        self.process.readyReadStandardError.connect(self.stderrReady)
        self.process.started.connect(lambda: self.p('Started!'))
        self.process.finished.connect(lambda: self.p1('Finished!'))
        print('Starting process')
        self.process.start(r'C:\ImageScripter_2\python.exe', [r"C:\Users\Automation3\Desktop\test.py"])
        ## filters output
        #import subprocess
        #proc = subprocess.Popen([r'C:\ImageScripter_2\python.exe',r"C:\Users\Automation3\Desktop\test.py"], stdout=subprocess.PIPE,shell=True)
        #while True:
        #    line = proc.stdout.readline()
        #    if line != '':
        #        # the real code does filtering here
        #        print("test:", line.rstrip())
        #        print(line)
        #    else:
        #        break

    def stdoutReady(self):
        text = str(self.process.readAllStandardOutput(),encoding = "utf-8")
        self.append(text)

    def stderrReady(self):
        text = str(self.process.readAllStandardError(),encoding = "utf-8")

        self.append(text)

    def append(self, text):
        cursor = self.ui.textEdit.textCursor()
        cursor.movePosition(cursor.End)
        cursor.insertText(text)
        self.ui.textEdit.setTextCursor(cursor)
        #cursor.insertText('\n')
        #self.ui.textEdit.verticalScrollBar().setValue(self.ui.textEdit.verticalScrollBar().maximum())
        self.ui.textEdit.ensureCursorVisible()














    def open_clicked(self):
        txt1 = ''
        name = ''
        name = QFileDialog.getOpenFileName(
            parent=self,
            caption=self.tr("Select a file"),
            filter=self.tr('Image files (*.py)'),
        )
        if name != '':
            file_name = name[0]
            if file_name != '':
                with open(file_name,'r') as f:
                    txt1 = f.read()
                    self.last_opened_file = file_name
                    self.ui.label.setText(self.last_opened_file)
        txt1 = os.linesep.join([s for s in txt1.splitlines() if s])
        self.editor.setText(txt1)



    def Save_clicked(self):
        text = self.editor.text()
        print(text)
        if self.last_opened_file == None:
            name = ''
            name = QFileDialog.getSaveFileName(
                parent=self,
                caption=self.tr("Select a file"),
                filter=self.tr('Image files (*.py)'),
            )
            if name != '':
                file_name = name[0]
                if file_name != '':
                    with open(file_name,'w') as f:
                        f.write(text)
        else:
            if self.last_opened_file != '':
                    with open(self.last_opened_file,'w') as f:
                        f.write(text)

    def Save_As_clicked(self):
        text = self.editor.text()
        name = ''
        name = QFileDialog.getSaveFileName(
            parent=self,
            caption=self.tr("Select a file"),
            filter=self.tr('Image files (*.py)'),
        )
        if name != '':
            file_name = name[0]
            if file_name != '':
                with open(file_name,'w') as f:
                    f.write(text)

    def Close_clicked(self):
        self.app.quit()

    def getITP8_Image_was_clicked(self):
        self.get_image_from_itp8()
        subprocess.Popen(r"C:\ImageScripter_2\python.exe C:\ImageScripter_2\Lib\site-packages\Script_Writer\diplay_image_for_capture.py", shell=True)






    def capture_button_clicked(self):
        import subprocess
        subprocess.Popen(r"C:\ImageScripter_2\python.exe C:\ImageScripter_2\Lib\site-packages\Script_Writer\snipping_tool.py", shell=True)


    def get_image_from_itp8(self):
        print("Getting image from ITP")
        try:
            Main_Image_File = r"C:\ImageScripter_2\Lib\site-packages\Script_Writer\image_file.png"
            destination_File = r"screenshot.png"
            nbytes = 4096
            print('show_image_from_itp8')
            #hostname = '192.168.1.2'
            hostname = '192.168.0.37'
            port = 2199
            username = 'root'
            password = 'N0rt3k$C'
            command = 'scrot /tmp/test.png'
            def createSSHClient():
                client = paramiko.SSHClient()
                #client.load_system_host_keys()
                client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                client.connect(hostname, port, username, password)
                return client
            client = paramiko.Transport((hostname, port))
            client.connect(username=username, password=password)
            stdout_data = []
            stderr_data = []
            session = client.open_channel(kind='session')
            session.exec_command(command)
            while True:
                if session.recv_ready():
                    data = session.recv(nbytes)
                    print(data)
                    stdout_data.append(data)
                if session.recv_stderr_ready():
                    data = session.recv_stderr(nbytes)
                    print(data)
                    stderr_data.append(data)
                if session.exit_status_ready():
                    break
            session.close()
            client.close()
            ssh = createSSHClient()
            scp = SCPClient(ssh.get_transport())
            scp.get('/tmp/test.png', destination_File)
            scp.close()
            picture = Image.open(destination_File)
            picture = picture.rotate(90, expand=True)
            picture.save(Main_Image_File)
            print('done')
        except Exception as e:
            try:
                ssh.close()
            except:
                pass
            try:
                scp.close()
            except:
                pass
            try:
                client.close()
            except:
                pass
            print(e)
        print("Finsihed Getting image from ITP")





if __name__ == '__main__':
    app = QApplication(sys.argv)
    Script_Writer = Script_Writer_Class(app)
    #Script_Writer.get_image_from_itp8()
    #Script_Writer.showMaximized()
    sys.exit(app.exec_())