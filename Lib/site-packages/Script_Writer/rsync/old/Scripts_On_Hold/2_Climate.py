from elan import ElanSettings
from elan import *
from ImageScripter import *
import os
import telnetlib
from elan import *
from pytank.Core import Settings
Settings.CaptureMode = False

def PowerAndroid():
    PanamaxIP = "192.168.0.199"
    Interface_Outlet = 5

    def PowerOn(x):
        x = str(x)
        string = "!SWITCH " + x + " ON"
        tn = telnetlib.Telnet(PanamaxIP, 23)
        user = ""
        tn.write(string.encode('ascii') + "\r\n".encode('ascii'))
        tn.close()
        print('cloased')

    def PowerOff(x):
        x = str(x)
        string = "!SWITCH " + x + " OFF"
        tn = telnetlib.Telnet(PanamaxIP, 23)
        user = ""
        tn.write(string.encode('ascii') + "\r\n".encode('ascii'))
        tn.close()
        print('Powered OFF')

    Viewer.Start()
    Viewer.CloseAndClean()

    if not os.path.exists(ElanSettings.adb_location):
        print('You need to set the adb location in Elan settings')
    else:
        os.chdir(ElanSettings.adb_location)
        os.system("adb start-server")

        PowerOff(Interface_Outlet)
        sleep(10)
        PowerOn(Interface_Outlet)

        # os.system("adb reboot")

    for i in range(500):
        try:
            if Android.away.Exists():
                os.system("adb shell settings put global stay_on_while_plugged_in 3")
                break
            elif Android.attentionpassword.Exists():
                os.system("adb shell settings put global stay_on_while_plugged_in 3")
                break
            else:
                print("Waiting for Android 3..")
                PowerOff(Interface_Outlet)
                sleep(10)
                PowerOn(Interface_Outlet)
                sleep(60)
                os.system("adb shell settings put global stay_on_while_plugged_in 3")

        except Exception as e:
            print("Exception -> " + str(e))
            print("Waiting for Android 4..")
            PowerOff(Interface_Outlet)
            sleep(10)
            PowerOn(Interface_Outlet)
            sleep(60)
            os.system("adb shell settings put global stay_on_while_plugged_in 3")

PowerAndroid()
Configurator.SetTimeZone()
Say("Running the Climate Script")
Configurator.Start()

Configurator.climate.Click()
Say("Adding Generic HVAC Unit")
AddNewDeviceSimple(Configurator.heatingandcoolingunits, "Generic HVAC Unit")
try:
    sleep(2)
    AddNewDevice.PushButton.Click('OK')
    Configurator.devicetypegenerichvacunit.Click()
except:
    try:
        AddNewDevice.Close()
    except:
        pass
    sleep(10)
    AddNewDeviceSimple(Configurator.heatingandcoolingunits, "Generic HVAC Unit")
    AddNewDevice.PushButton.Click('OK')
    try:
        Configurator.devicetypegenerichvacunit.Click()
    except:
        AddNewDevice.Close()
        sleep(10)
        AddNewDeviceSimple(Configurator.heatingandcoolingunits, "Generic HVAC Unit")
        AddNewDevice.devicetype.RealClick()
        AddNewDevice.PushButton.Click('OK')
        try:
            # didn't properly select generic hvac unit and close
            Configurator.devicetypegenerichvacunit.Click()
        except:
            sleep(3)
            AddNewDevice.generichvacunitimage.RealClick()
            sleep(1)
            AddNewDevice.PushButton.Click('OK')
            Configurator.devicetypegenerichvacunit.Click()

Say("Adding Virtual HVAC Network Communication Device")
addNewComDev("Virtual HVAC Network", "Ethernet")
Say("Adding Thermostats")
try:
    # Picked denon device here failed
    Configurator.discoverdevices.Click()
except ValueError:
    Configurator.virtualhvacnetwork.RightClickType('d')
    sleep(1)
    HlConfig.PushButton.Click('Yes')
    sleep(2)
    addNewComDev("Virtual HVAC Network", "Ethernet")
    Configurator.discoverdevices.Click()

Say("Changing to heat")
sleep(2)
Configurator.lighting.Click()
Configurator.climate.Click()
sleep(4)
Configurator.thermostatid1.Click()
Configurator.name.Wait()
sleep(1)
# Configurator.asdfasdf.SetThreshold(.70)
Configurator.asdfasdf.Wait(threshold=.70)
Configurator.Edit.SetText(0, '@@@')

 # Remove cool to none #Fix
Configurator.coolingunit.RealClick(xoffset = 200)
Configurator.noneindropdown.RealClick()
Configurator.apply.Wait()
sleep(2)
Configurator.apply.Click()
sleep(2)
Say("Changing to cool")
Configurator.lighting.Click()
Configurator.climate.Click()
sleep(4)
################Failed here (Save changes popup)
Configurator.thermostatid2.Click()
Configurator.name.Wait()
sleep(1)

# Configurator.zsdfgsdfgdfg.Wait()
Configurator.Edit.SetText(0, '@@@')

 # Remove heat to none #Fix
Configurator.heatingunit.RealClick(xoffset = 200)
Configurator.noneindropdown.RealClick()

Configurator.apply.Wait()
sleep(2)
Configurator.apply.Click()
sleep(2)

Configurator.system.Click()
try:
    sleep(1)
    Hlconfig.PushButton.Click('Yes')
except:
    pass

Configurator.RestartHard()
Configurator.WaitForControllerToComeBackOnline()
try:
    ElanConnectPro.CloseAndClean()
except:
    pass

if 'Android' not in Android.Platform:
    Say("Opening the Viewer")
    Android.Start()
else:
    pass
sleep(3)

if Android.shuddar.Exists():
    Android.shuddar.Click()
else:
    print("No Shudder")
sleep(5)
try:
    Android.climatehome.Click()
except:
    PowerAndroid()
    sleep(10)
    Android.climatehome.Click()
# Error cv2.error
sleep(3)
try:
    Android.heat68.Click()
except:
    try:
        Android.heat69.Click()
        sleep(2)
    except:
        Android.climatehome.Click()
        sleep(10)
        try:
            Android.heat68.Click()
        except:
            Android.heat69.Click()
            sleep(2)

Say("Turning the temperature to 88 degrees")
Android.tempup.ClickAndRepeat(29)

Android.heatbig88.Wait()

Say("Turning the temperature to 39 degrees")
Android.tempdown.ClickAndRepeat(50)
# Turn fan out
Say("Turning the fan to on")
try:
    Android.fanautomodeon.Click()
except:
    try:
        Android.fanmodeon2.Click()
    except:
        Android.fanautomodeon22.Click()
        Android.fanoninoptions.Click()

Android.fanon.Click()
# Turn heat mode off

while True:
    try:
        sleep(3)
        Android.heatmodeon88234234.Click()
        if Android.heatoff2.Exists():
            Android.heatoff2.Click()
        else:
            Android.heatmodeon88234234.Click()
            Android.heatoff2.Click()
        break
    except:
        print("issue 110")
        pass

while True:
    try:
        Android.heatisoff122.Click()
        Android.heatmodeon4.Click()
        break
    except:
        print("issue118")
        pass

sleep(3)
################################################################
# Scheduling Page

Say("Going to the Scheduling Page")
Android.timeicon.Click()

Android.heat68606864.Wait()
Say("Changing to timed hold")

try:
    Android.runprogram.Click()
except:
    Android.runprogram2.Click()

Android.timedholdinmenu.Click()

Android.timedhold.Click()
Android.runprograminmenu.Click()
sleep(3)
try:
    Android.runprogram.Click()
except:
    Android.runprogram2.Click()
Android.timedholdinmenu.Click()

Android.holdfor.Wait()
Say("Looks like Timed hold is set")
Say("Changing Time")

Android.time7am.Click(nosay=True)
Android.timeup.ClickAndRepeat(3)
# Android.timeup.Click(nosay = True)
# Android.timeup.Click(nosay = True)
# Android.timeup.Click(nosay = True)

Android.time745am.Click(nosay=True)
Android.timedown.ClickAndRepeat(4)
# Android.timedown.Click(nosay = True)
# Android.timedown.Click(nosay = True)
# Android.timedown.Click(nosay = True)
# Android.timedown.Click(nosay = True)
sleep(2)
Android.time645.Wait()

Say("Time is on six 45 as planned")

# Temphold
Android.tempholdup.Click()
Android.tempholdup.Click()
Android.tempholdup.Click()

Android.tempholddown.Click()
Android.tempholddown.Click()
Android.tempholddown.Click()

# Change to permanenthold mode so temps dont change

Android.timedhold3.Click()

# Stopped here no perm
Android.timedhold888234234.Click()
# Stopped here no perm picture?
Android.permanenthold.Click()

# HEAT
Say("Changing Heat")
print('#3')
p = 0
for i in range(100):
    try:
        Android.heatsmall68.Click(yoffset=20, nosay=True)
        Android.heatup.Click(nosay=True)
        sleep(2)
        Android.heatsmall69.Wait()
        break
    except Exception as e:
        print("Exception -> " + str(e))
        if p >= 30:
            raise
        else:
            p += 1
            continue

Android.heatsmall69.Click(nosay=True)
Android.heatdown.Click(nosay=True)

sleep(2)
print('#4')
try:
    Android.heatsmall68.Wait()
except:
    Android.heatsmall69.Wait()

Say("Heat is on sixty eight")

# Fan

Android.fanmode.Click(yoffset=60, nosay=True)

Android.fanmodeon4.Click(nosay=True)

sleep(2)

Android.fanmodeissettoon.Wait()
Say("fan is on")

Say("Scheduling Page looks good")
Say("Going to the climate history page")
Android.climatehistorypageicon.Click()

Android.heattopbarred.Wait()

Say("Heat History Page looks good")
try:
    Android.gonextarrow.Click()
except:
    Android.gonextarrow2.Click()
Android.cooltopright.Wait()
Say("Cool History Page looks good")
sleep(3)

Android.shuddar.Click()
Android.cool85.Click()
# Android.big85.Wait()

Say("Turning the temperature to 90 degrees")
Android.tempup.ClickAndRepeat(7)

Android.coolbig90.Wait()

Say("Turning the temperature to 41 degrees")
Android.tempdown.ClickAndRepeat(50)
# Turn fan out
Say("Turning the fan to on")

print("Turning the fan to on")
while True:
    try:
        Android.fanmodeisinauto.Click()
        Android.fanonintheinnndermenu.Click()
        break
    except:
        print('issue')
        pass

# Turn cool mode off
Say("Turning cool mode to off")
# Turn Cool mode off

Android.coolmodeon.Click()
Android.cooloff.Click()

Android.coolmodeoff.Click()
Android.coolon.Click()

Android.coolmodeon.Wait()

for i in range(10):
    try:
        Android.coolisthemodethatson.Click()
        Android.cooloffmodeselectinmenu.Click()
        break
    except:
        if i >= 9:
            raise ValueError()
        else:
            sleep(1)
            Android.roomtemp.Click()
            print('having issue, trying again')

while True:
    try:
        Android.fanisonauto.Click()
        Android.fanonintheinnermenu.Click()
        break
    except:
        print('issue 279 line')

Android.fanon.Wait()

Say('bring viewer to home')

Android.shuddar.Click()

Android.houseLogo.Click()

Android.shuddar.Click()
#
Say('Adding Heat and Cool Thermostat')
Configurator.Start()
Configurator.climate.Click()

Configurator.thermostats.RightClickType('a')

AddNewDevice.ListView.Select(1, "Virtual HVAC Thermostat")

AddNewDevice.PushButton.Click('OK')
Configurator.CloseAndClean()
sleep(3)

Android.climatehome.Click()

sleep(3)
# failed here -> increase wait()
try:
    Android.heatmode60updown.ClickPip(Android.overview_temp_up)
except:
    # failed here -> increase wait()
    Android.heatmode60updown.Wait()
    Android.heatmode60updown.ClickPip(Android.overview_temp_up)

Android.heatmode60updown.ClickPip(Android.overview_temp_down)
Android.heatmode60updown.ClickPip(Android.overview_temp_down)

Android.coolmode85updown.ClickPip(Android.overview_temp_up)
Android.coolmode85updown.ClickPip(Android.overview_temp_down)
Android.coolmode85updown.ClickPip(Android.overview_temp_down)

Android.automode8560updown.ClickPip(Android.overview_temp_up)
Android.automode8560updown.ClickPip(Android.overview_temp_down)
Android.automode8560updown.ClickPip(Android.overview_temp_down)

Android.heatcool22.Wait()

# failed here Android.automode8163updown.Click() missing
Android.automode8updown.Click(xoffset=100)

Say("Turning the Cool temperature to 87 degrees")
Android.bigcool.ClickPip(Android.tempup)
Android.bigcool.ClickPip(Android.tempup)
Android.bigcool.ClickPip(Android.tempup)
Android.bigcool.ClickPip(Android.tempup)
Android.bigcool.ClickPip(Android.tempup)
Android.bigcool.ClickPip(Android.tempup)

Android.bigcool87.Wait()
Say("Turning the Cool temperature to 86 degrees")
Android.bigcool.ClickPip(Android.tempdown)

Say("Turning the Heat temperature to 63 degrees")
Android.bigheat.ClickPip(Android.tempup)
Android.bigheat.ClickPip(Android.tempdown)

Android.bigheat63.Wait()

Say("Turning the Heat temperature to 62 degrees")
Android.bigheat.ClickPip(Android.tempdown)

Android.bigheat82.Wait()

while True:
    try:
        Android.fanautomodeon6.Click()
        Android.fanon.Click()
        break
    except:
        print('issue 361')
        pass

# Turn cool mode off
Say("Turning cool mode to off")
# Turn Cool mode off
try:
    Android.automodeon.Click()
except:
    sleep(2)
    Android.automodeon2.Click()

Android.autooff.Click()

Android.automodeoff.Click()
Android.autoon.Click()
Android.automodeon.Wait()

while True:
    try:
        Android.fanautomodeon6.Click()
        Android.fanon1.Click()
        break
    except:

        print("issue 387")
        pass

while True:
    try:
        Android.fanon2.Click()
        Android.fanmodegoestoauto1.Click()
        break
    except:
        print('issue 396')
        pass
print('asdasds')

#############################################################
# Scheduling Page

Say("Going to the Scheduling Page")
Android.timeicon.Click()

Android.auto6860686476857672.Wait()
Say("Changing to Run Program")

Android.timedhold.Click()
Android.runprograminmenu.Click()

Say("Changing to Timed Hold")
sleep(3)
try:
    Android.runprogram.Click()
except:
    Android.runprogram2.Click()
sleep(3)
try:
    Android.timedholdinmenu.Click()
except:
    try:
        Android.timedholdinmenu.Wait()
        Android.timedholdinmenu.Click()
    except:
        try:
            Android.runprogram2.Click()
            Android.timedholdinmenu.Wait()
            Android.timedholdinmenu.Click()
        except:
            Android.timedholdinmenu2.Wait()
            Android.timedholdinmenu2.Click()

sleep(1)
try:
    Android.holdfor.Wait()
except:
    sleep(3)
    Android.holdfor.Wait()

Say("Looks like Timed hold is set")
Say("Changing Time")

Android.time7am.Click(nosay=True)
Android.timeup.ClickAndRepeat(3)
# Android.timeup.Click(nosay = True)
# Android.timeup.Click(nosay = True)
# Android.timeup.Click(nosay = True)

Android.time745am.Click(nosay=True)
Android.timedown.ClickAndRepeat(4)
# Android.timedown.Click(nosay = True)
# Android.timedown.Click(nosay = True)
# Android.timedown.Click(nosay = True)
# Android.timedown.Click(nosay = True)
sleep(2)
Android.time645.Wait()

Say("Time is on six 45 as planned")

# Temphold
Android.tempholdup.Click()
Android.tempholdup.Click()
Android.tempholdup.Click()
try:
    Android.tempholddown.Click()
    Android.tempholddown.Click()
    Android.tempholddown.Click()
except:
    ####Weird fail
    Android.blankarea2.Click()
    sleep(15)
    Android.tempholddown.Click()
    Android.tempholddown.Click()
    Android.tempholddown.Click()

# Change to permanenthold mode so temps dont change
Android.timedhold.Click()

# Failed here adb
##################Stoped here looking for perm
Android.timedhold2.Click()

# Stoped here trying to click perm hold
try:
    Android.permanenthold.Click()
except:
    Android.timedhold2.Click()
    sleep(2)
    Android.permanenthold.Click()

# HEAT
Say("Changing Heat")
# Failed Here for unknown reason
try:
    print('#5')
    Android.heatsmall68.Click(yoffset=20, nosay=True)
except:
    sleep(10)
    # adb failed here
    print('#6')
    Android.heatsmall68.Click(yoffset=20, nosay=True)
Android.heatup.Click(nosay=True)

sleep(2)
Android.heatsmall69.Wait()

Android.heatsmall69.Click(nosay=True)
Android.heatdown.Click(nosay=True)

sleep(2)
try:
    print('#2')
    Android.heatsmall68.Wait()
except:
    Android.heatsmall69.Click(nosay=True)
    Android.heatdown2.Click(nosay=True)
    sleep(10)
    print('#1')
    Android.heatsmall68.Wait()

Say("Heat is on sixty eight")

# Cool
Say("Changing Cool")

Android.autocoolsmall76.Click(yoffset=20, nosay=True)
Android.autocoolup.Click(nosay=True)

sleep(5)

Android.autocoolsmall77.Wait()
Android.autocoolsmall77.Click(yoffset=30, nosay=True)
Android.autocooldown.Click(nosay=True)

sleep(5)
try:
    Android.autocoolsmall76.Wait()
except Exception as e:
    print(e)
    Android.autocoolsmall77.Wait()
    Android.autocoolsmall77.Click(yoffset=30, nosay=True)
    Android.autocooldown.Click(nosay=True)
    Android.autocoolsmall76.Wait()

Say("Cool is on seventy six")

# Fan

Android.fanmode.Click(yoffset=70, nosay=True)
try:
    Android.fanmodeon3.Click(nosay=True)
except:
    Android.fanmode.Click(yoffset=70, nosay=True)
    Android.fanmodeon3.Click(nosay=True)

sleep(2)

Android.fanmodeissettoon.Wait()
Say("fan is on")

Say("Scheduling Page looks good")
Say("Going to the heat cool history page")
Android.climatehistorypageicon.Click()

sleep(10)
Android.heatcooltopbar.SetThreshold(.87)
Android.heatcooltopbar.Wait()
Say("Heat Cool History Page looks good")

if 'Android' not in Android.Platform:
    Say("Opening the Viewer")
    Android.CloseAndClean()
else:
    pass
Configurator.Reset()
Say("Climate Test Passed")


