import os
import ctypes
import shutil, errno
import stat
import time
from distutils.dir_util import copy_tree
print("Starting")
def copyanything(src, dst):
    try:
        shutil.copytree(src, dst)
    except OSError as exc: # python >2.5
        if exc.errno == errno.ENOTDIR:
            shutil.copy(src, dst)
        else: raise
def errorRemoveReadonly(func, path, exc):
    excvalue = exc[1]
    if func in (os.rmdir, os.remove) and excvalue.errno == errno.EACCES:
        # change the file to be readable,writable,executable: 0777
        os.chmod(path, stat.S_IRWXU | stat.S_IRWXG | stat.S_IRWXO)
        # retry
        func(path)
    else:
        shutil.rmtree(path)
        print('raiseenter code here')



def Mbox(title, text, style):
    return ctypes.windll.user32.MessageBoxW(0, text, title, style)


#Mbox('Notice', 'Started exporting, please wait for the finished message', 1)
old_elan = r"C:/Settings/elan/"
new_elan = r"C:/ImageScripter_2/Lib/site-packages/elan/"
Path = r"C:\ImageScripter_2\Lib\site-packages\Script_Writer\rsync"
os.chdir(Path)

print('Starting, Please wait...')


try:
    shutil.rmtree('old', ignore_errors=False, onerror=errorRemoveReadonly)
    #rmtree('old')
    print('Removed /OLD')
except Exception as e:
    pass
    print(e)

try:
    shutil.rmtree('new', ignore_errors=False, onerror=errorRemoveReadonly)
    #rmtree('new')
    print('Removed /NEW')
except Exception as e:
    pass
    print(e)

try:
    shutil.rmtree('difference', ignore_errors=False, onerror=errorRemoveReadonly)
    #rmtree('difference')
    print('Removed /DIFF')
except Exception as e:
    pass
    print(e)



print("Copying New")
copyanything(new_elan,'new')
print("Copied")
print("Copying OLD")
copyanything(old_elan,'old')
print("Copied")

#"C:/Settings/elan/"
#"C:/ImageScripter_2/Lib/site-packages/elan/"
#rsync -rvcm --compare-dest=../old/ new/ difference/

os.system("rsync  -rvcm --no-p --no-g --no-o --compare-dest=../old/ new/ difference/")

print("Finished Gettting Differences")

NAS_DRIVE = r"\\172.16.43.21\nas\Cloud_Drive\Writer_Backups"

fromDirectory = r"C:\ImageScripter_2\Lib\site-packages\Script_Writer\rsync\difference"
toDirectory = NAS_DRIVE

print('Copying to NAS -> ',NAS_DRIVE)

os.chdir(NAS_DRIVE)
timeString = str(time.time())

End_folder = 'smart_export_' + timeString

#os.mkdir(End_folder)
#os.chdir(End_folder)

copy_tree(fromDirectory,End_folder)


print('Done Copying to NAS -> ',End_folder)



print("Doing Cleanup")
os.chdir(Path)
try:
    shutil.rmtree('difference', ignore_errors=False, onerror=errorRemoveReadonly)
    #os.system('rmdir /S /Q "{}"'.format('difference'))
    #rmtree('difference')
    print('Removed /DIFF')
except Exception as e:
    print(e)

try:
    shutil.rmtree('new', ignore_errors=False, onerror=errorRemoveReadonly)
    #os.system('rmdir /S /Q "{}"'.format('new'))
    #rmtree('new')
    print('Removed /NEW')
except Exception as e:
    print(e)

try:
    shutil.rmtree('old', ignore_errors=False, onerror=errorRemoveReadonly)
    #os.system('rmdir /S /Q "{}"'.format('old'))
    #rmtree('old')
    print('Removed /OLD')
except Exception as e:
    print(e)


print("Finished Cleanup")

#input('Finished')

#os.system("rsync -rvcm  --compare-dest=../old/ new/ difference/")
#os.system("rsync -rvcm --no-perms --no-owner --no-group --compare-dest=../old/ new/ difference/")
def Mbox(title, text, style):
    return ctypes.windll.user32.MessageBoxW(0, text, title, style)
Mbox('Notice', 'Finished', 1)