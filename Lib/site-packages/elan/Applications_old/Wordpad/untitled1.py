from elan import ElanSettings
from elan import *
from ImageScripter import *
import os
import telnetlib


def PowerAndroid():

    PanamaxIP = "192.168.0.199"
    Interface_Outlet = 5
    
    def PowerOn(x):
        x = str(x)
        string = "!SWITCH " +  x + " ON"
        tn = telnetlib.Telnet(PanamaxIP, 23)
        user = ""
        tn.write(string.encode('ascii') + "\r\n".encode('ascii'))
        tn.close()
        print('cloased')
    
    
    
    def PowerOff(x):
        x = str(x)
        string = "!SWITCH " +  x + " OFF"
        tn = telnetlib.Telnet(PanamaxIP, 23)
        user = ""
        tn.write(string.encode('ascii') + "\r\n".encode('ascii'))
        tn.close()
        print('Powered OFF')
        
    Viewer.Start()
    Viewer.CloseAndClean()
    
    
    if not os.path.exists(ElanSettings.adb_location):
        print('You need to set the adb location in Elan settings')
    else:
        os.chdir(ElanSettings.adb_location)
        os.system("adb start-server")
        
        PowerOff(Interface_Outlet)
        sleep(10)
        PowerOn(Interface_Outlet)
        
        #os.system("adb reboot")    
        
    for i in range(500):
        try:
            if Android.away.Exists():
                os.system("adb shell settings put global stay_on_while_plugged_in 3")
                break
            elif Android.attentionpassword.Exists():
                os.system("adb shell settings put global stay_on_while_plugged_in 3")
                break
            else:
                print("Waiting for Android 3..")
                PowerOff(Interface_Outlet)
                sleep(10)
                PowerOn(Interface_Outlet)
                sleep(60)
                os.system("adb shell settings put global stay_on_while_plugged_in 3")
                
        except Exception as e:
            print("Exception -> " + str(e))
            print("Waiting for Android 4..")
            PowerOff(Interface_Outlet)
            sleep(10)
            PowerOn(Interface_Outlet)
            sleep(60)
            os.system("adb shell settings put global stay_on_while_plugged_in 3")

####################################
print("Power Android")
PowerAndroid()


















from elan import *
C = Configurator
V = Android
AND = AddNewDevice

from pytank.Core import Settings
Settings.CaptureMode = False


def main():
    C.SetTimeZone()
    Say("Running the Climate Script")
    sleep(2)
    C.Start()
    C.climate.Click()
    Say("Adding Generic HVAC Unit")
    AddNewDeviceSimple(C.heatingandcoolingunits,"Generic HVAC Unit")
    try:
        sleep(2)
        AND.PushButton.Click('OK')
        C.devicetypegenerichvacunit.Click()
    except:
        try:
            AND.Close()
        except:
            pass
        sleep(10)
        AddNewDeviceSimple(C.heatingandcoolingunits,"Generic HVAC Unit")
        AND.PushButton.Click('OK')
        try:
            C.devicetypegenerichvacunit.Click()
        except:
            AND.Close()
            sleep(10)
            AddNewDeviceSimple(C.heatingandcoolingunits,"Generic HVAC Unit")
            AddNewDevice.devicetype.RealClick()
            AND.PushButton.Click('OK')
            try:
                #didn't properly select generic hvac unit and close
                C.devicetypegenerichvacunit.Click()
            except:
                sleep(3)
                AddNewDevice.generichvacunitimage.RealClick()
                sleep(1)
                AND.PushButton.Click('OK')
                C.devicetypegenerichvacunit.Click()
            
     
    Say("Adding Virtual HVAC Network Communication Device")
    addNewComDev("Virtual HVAC Network","Ethernet")
    Say("Adding Thermostats")
    try:
        #Picked denon device here failed
        C.discoverdevices.Click()
    except ValueError:
        C.virtualhvacnetwork.RightClickType('d')
        sleep(1)
        HlConfig.PushButton.Click('Yes')
        sleep(2)
        addNewComDev("Virtual HVAC Network","Ethernet")
        C.discoverdevices.Click()

    Say("Changing to heat")
    sleep(2)
    C.lighting.Click()
    C.climate.Click()
    sleep(4)
    C.thermostatid1.Click()
    C.name.Wait()
    sleep(1)
    #C.asdfasdf.SetThreshold(.70)
    C.asdfasdf.Wait(threshold = .70)
    C.Edit.SetText(0,'@@@')

    C.ComboBox.Select(4,0)#Remove cool to none #Fix 
    #Configurator.ComboBox.Select(3,0)#Fix Remove cool to none #Broke Later
    C.apply.Wait()
    sleep(2)
    C.apply.Click()
    sleep(2)
    Say("Changing to cool")
    C.lighting.Click()
    C.climate.Click()
    sleep(4)
    ################Failed here (Save changes popup)
    C.thermostatid2.Click()
    C.name.Wait()
    sleep(1)
    
    #C.zsdfgsdfgdfg.Wait()
    C.Edit.SetText(0,'@@@')
    C.ComboBox.Select(3,0)#Turn heat off cool only #Fix again
    #C.ComboBox.Select(2,0) #Fix   Broke later
    C.apply.Wait()
    sleep(2)
    C.apply.Click()
    sleep(2)
    C.system.Click()
    try:
        sleep(1)
        Hlconfig.PushButton.Click('Yes')
    except:
        pass

    C.RestartHard()
    C.WaitForControllerToComeBackOnline()
    try:
        ElanConnectPro.CloseAndClean()
    except:
        pass
    
    if 'Android' not in V.Platform:
        Say("Opening the Viewer")
        V.Start()
    else:
        pass
    sleep(3)
 
    if V.shuddar.Exists():
        V.shuddar.Click()
    else:
        print("No Shudder")
    sleep(5)
    try:
        V.climatehome.Click()
    except:
        PowerAndroid()
        sleep(10)
        V.climatehome.Click()
    #Error cv2.error
    sleep(3)
    try:
        V.heat68.Click()
    except:
        try:
            V.heat69.Click()
            sleep(2)
        except:
            V.climatehome.Click()
            sleep(10)
            try:
                V.heat68.Click()
            except:
                V.heat69.Click()
                sleep(2)
            
            
    
    Say("Turning the temperature to 88 degrees")
    V.tempup.ClickAndRepeat(29)
    
    V.heatbig88.Wait()
                
    Say("Turning the temperature to 39 degrees")
    V.tempdown.ClickAndRepeat(50)  
    #Turn fan out
    Say("Turning the fan to on")
    try:
        V.fanautomodeon.Click()
    except:
        try:
            V.fanmodeon2.Click()
        except:
            V.fanautomodeon22.Click()
            V.fanoninoptions.Click()
            
    V.fanon.Click()
    #Turn heat mode off
    
    while True:
        try:
            sleep(3)
            V.heatmodeon88234234.Click()
            if V.heatoff2.Exists():
                V.heatoff2.Click()
            else:
                V.heatmodeon88234234.Click()
                V.heatoff2.Click()
            break
        except:
            print("issue 110")
            pass

    while True:
        try:
            V.heatisoff122.Click()
            V.heatmodeon4.Click()
            break
        except:
            print("issue118")
            pass
    
    sleep(3)
   ################################################################
    #Scheduling Page

    Say("Going to the Scheduling Page") 
    V.timeicon.Click()
    
    
    V.heat68606864.Wait()
    Say("Changing to timed hold")
    
    try:
        V.runprogram.Click()
    except:
        V.runprogram2.Click()
    
    V.timedholdinmenu.Click()     
    
    
    V.timedhold.Click()
    V.runprograminmenu.Click()
    sleep(3)
    try:
        V.runprogram.Click()
    except:
        V.runprogram2.Click()
    V.timedholdinmenu.Click()
    
    V.holdfor.Wait()
    Say("Looks like Timed hold is set")
    Say("Changing Time") 

    V.time7am.Click(nosay = True)
    V.timeup.ClickAndRepeat(3)
    #V.timeup.Click(nosay = True)
    #V.timeup.Click(nosay = True)
    #V.timeup.Click(nosay = True)

    
    V.time745am.Click(nosay = True)
    V.timedown.ClickAndRepeat(4)
    #V.timedown.Click(nosay = True)
    #V.timedown.Click(nosay = True)    
    #V.timedown.Click(nosay = True)  
    #V.timedown.Click(nosay = True)
    sleep(2)
    V.time645.Wait()
    
    Say("Time is on six 45 as planned")
    
    
    #Temphold
    V.tempholdup.Click()
    V.tempholdup.Click()    
    V.tempholdup.Click()    
    
    V.tempholddown.Click()
    V.tempholddown.Click()
    V.tempholddown.Click()
    
    

    
    #Change to permanenthold mode so temps dont change
    
    V.timedhold3.Click()
    
    #Stopped here no perm
    V.timedhold888234234.Click()
    #Stopped here no perm picture?
    V.permanenthold.Click()
    
    
    
    
    #HEAT
    Say("Changing Heat")
    print('#3')
    p = 0
    for i in range(100):
        try:
            V.heatsmall68.Click(yoffset = 20,nosay = True)
            V.heatup.Click(nosay = True)
            sleep(2)
            V.heatsmall69.Wait()
            break
        except Exception as e:
            print("Exception -> " + str(e))
            if p >= 30:
                raise
            else:
                p += 1
                continue
      
        
    
    V.heatsmall69.Click(nosay = True)
    V.heatdown.Click(nosay = True)
   
    sleep(2)
    print('#4')
    try:
        V.heatsmall68.Wait()
    except:
        V.heatsmall69.Wait()
        
    
    Say("Heat is on sixty eight")

    #Fan
    
    V.fanmode.Click(yoffset = 60,nosay = True)
 
    V.fanmodeon4.Click(nosay = True)
        
    sleep(2)

    V.fanmodeissettoon.Wait()
    Say("fan is on")
   
      
    
    Say("Scheduling Page looks good") 
    Say("Going to the climate history page")
    V.climatehistorypageicon.Click()
    
    
    V.heattopbarred.Wait()
    
    Say("Heat History Page looks good")
    try:
        V.gonextarrow.Click()
    except:
        V.gonextarrow2.Click()
    V.cooltopright.Wait()
    Say("Cool History Page looks good")
    sleep(3)

    V.shuddar.Click()
    V.cool85.Click()
    #V.big85.Wait() 
    
    Say("Turning the temperature to 90 degrees")
    V.tempup.ClickAndRepeat(7)
    
    V.coolbig90.Wait()

    Say("Turning the temperature to 41 degrees")
    V.tempdown.ClickAndRepeat(50)  
    #Turn fan out
    Say("Turning the fan to on")
    
    print("Turning the fan to on")
    while True:
        try:
            V.fanmodeisinauto.Click()
            V.fanonintheinnndermenu.Click()
            break
        except:
            print('issue')
            pass
    
    #Turn cool mode off
    Say("Turning cool mode to off")
                                #Turn Cool mode off
    
    V.coolmodeon.Click()
    V.cooloff.Click()
    
    V.coolmodeoff.Click()
    V.coolon.Click()
    
    V.coolmodeon.Wait()
    
    for i in range(10):
        try:
            V.coolisthemodethatson.Click()
            V.cooloffmodeselectinmenu.Click()
            break
        except:
            if i >= 9:
                raise ValueError()
            else:
                sleep(1)
                V.roomtemp.Click()
                print('having issue, trying again')
           
     
    while True:
        try:
            V.fanisonauto.Click()
            V.fanonintheinnermenu.Click()
            break
        except:
            print('issue 279 line')
        
    V.fanon.Wait()
   
    Say('bring viewer to home')
 
    V.shuddar.Click()
    
    V.houseLogo.Click()
    
    V.shuddar.Click()
    #
    Say('Adding Heat and Cool Thermostat')
    C.Start()
    C.climate.Click()
    
    C.thermostats.RightClickType('a')
    
    
    AND.ListView.Select(1,"Virtual HVAC Thermostat")
    
    
    AND.PushButton.Click('OK')
    C.CloseAndClean()
    sleep(3)
 
    V.climatehome.Click()
  
    sleep(3)
    #failed here -> increase wait()
    try:
        V.heatmode60updown.ClickPip(V.overview_temp_up)
    except:
        #failed here -> increase wait()
        V.heatmode60updown.Wait()
        V.heatmode60updown.ClickPip(V.overview_temp_up)
        
    V.heatmode60updown.ClickPip(V.overview_temp_down)
    V.heatmode60updown.ClickPip(V.overview_temp_down)


    V.coolmode85updown.ClickPip(V.overview_temp_up)
    V.coolmode85updown.ClickPip(V.overview_temp_down)
    V.coolmode85updown.ClickPip(V.overview_temp_down)
  
    
    V.automode8560updown.ClickPip(V.overview_temp_up)
    V.automode8560updown.ClickPip(V.overview_temp_down)
    V.automode8560updown.ClickPip(V.overview_temp_down)
    
    
    
    V.heatcool22.Wait()
    
    #failed here V.automode8163updown.Click() missing
    V.automode8updown.Click(xoffset = 100)
    
    Say("Turning the Cool temperature to 87 degrees")
    V.bigcool.ClickPip(V.tempup)
    V.bigcool.ClickPip(V.tempup)
    V.bigcool.ClickPip(V.tempup)
    V.bigcool.ClickPip(V.tempup)
    V.bigcool.ClickPip(V.tempup)
    V.bigcool.ClickPip(V.tempup)
    

    V.bigcool87.Wait() 
    Say("Turning the Cool temperature to 86 degrees")
    V.bigcool.ClickPip(V.tempdown)
    
 
    Say("Turning the Heat temperature to 63 degrees")
    V.bigheat.ClickPip(V.tempup)
    V.bigheat.ClickPip(V.tempdown)
    
    V.bigheat63.Wait()

    Say("Turning the Heat temperature to 62 degrees")
    V.bigheat.ClickPip(V.tempdown)  
    
    V.bigheat82.Wait()
    
    
    while True:
        try:
            V.fanautomodeon6.Click()
            V.fanon.Click()
            break
        except:
            print('issue 361')
            pass

    #Turn cool mode off
    Say("Turning cool mode to off")
                                #Turn Cool mode off
    try:
        V.automodeon.Click()
    except:
        sleep(2)
        V.automodeon2.Click()
        
    V.autooff.Click()
    
    V.automodeoff.Click()
    V.autoon.Click()
    V.automodeon.Wait()
    
    
    while True:
        try:
            V.fanautomodeon6.Click()
            V.fanon1.Click()
            break
        except:
            
            print("issue 387")
            pass

    while True:
        try:
            V.fanon2.Click()
            V.fanmodegoestoauto1.Click()
            break
        except:
            print('issue 396')
            pass
    print('asdasds')
        
    #############################################################   
    #Scheduling Page

    Say("Going to the Scheduling Page") 
    V.timeicon.Click()


    V.auto6860686476857672.Wait()
    Say("Changing to Run Program")
    
    
    V.timedhold.Click()
    V.runprograminmenu.Click()
    
    Say("Changing to Timed Hold")
    sleep(3)
    try:
        V.runprogram.Click()
    except:
        V.runprogram2.Click()
    sleep(3)
    try:
        V.timedholdinmenu.Click()
    except:
        try:
            V.timedholdinmenu.Wait()
            V.timedholdinmenu.Click()
        except:
            try:
                V.runprogram2.Click()
                V.timedholdinmenu.Wait()
                V.timedholdinmenu.Click()
            except:
                V.timedholdinmenu2.Wait()
                V.timedholdinmenu2.Click()
                
      
    sleep(1)
    try:      
        V.holdfor.Wait()
    except:
        sleep(3)
        V.holdfor.Wait()
    
   
    Say("Looks like Timed hold is set")
    Say("Changing Time") 
    
    V.time7am.Click(nosay = True)
    V.timeup.ClickAndRepeat(3)
    #V.timeup.Click(nosay = True)
    #V.timeup.Click(nosay = True)
    #V.timeup.Click(nosay = True)

    
    V.time745am.Click(nosay = True)
    V.timedown.ClickAndRepeat(4)
    #V.timedown.Click(nosay = True)
    #V.timedown.Click(nosay = True)    
    #V.timedown.Click(nosay = True)  
    #V.timedown.Click(nosay = True)
    sleep(2)
    V.time645.Wait()
    
    Say("Time is on six 45 as planned")
    
    
    #Temphold
    V.tempholdup.Click()
    V.tempholdup.Click()    
    V.tempholdup.Click()    
    try:
        V.tempholddown.Click()
        V.tempholddown.Click()
        V.tempholddown.Click()
    except:
        ####Weird fail
        V.blankarea2.Click()
        sleep(15)
        V.tempholddown.Click()
        V.tempholddown.Click()
        V.tempholddown.Click()

    
    #Change to permanenthold mode so temps dont change
    V.timedhold.Click()

    
    #Failed here adb
    ##################Stoped here looking for perm
    V.timedhold2.Click()
    
    
    #Stoped here trying to click perm hold
    try:
        V.permanenthold.Click()
    except:
        V.timedhold2.Click()
        sleep(2)
        V.permanenthold.Click()
           
        
    
    
    
    
    #HEAT
    Say("Changing Heat")
    #Failed Here for unknown reason
    try:
        print('#5')
        V.heatsmall68.Click(yoffset = 20,nosay = True)
    except:
        sleep(10)
        #adb failed here
        print('#6')
        V.heatsmall68.Click(yoffset = 20,nosay = True)
    V.heatup.Click(nosay = True)

    sleep(2)
    V.heatsmall69.Wait()

    V.heatsmall69.Click(nosay = True)
    V.heatdown.Click(nosay = True)
   
    sleep(2)
    try:
        print('#2')
        V.heatsmall68.Wait()
    except:
        V.heatsmall69.Click(nosay = True)
        V.heatdown2.Click(nosay = True)
        sleep(10)
        print('#1')
        V.heatsmall68.Wait()
    
    Say("Heat is on sixty eight")
    
  #Cool
    Say("Changing Cool")
    
    V.autocoolsmall76.Click(yoffset = 20,nosay = True)
    V.autocoolup.Click(nosay = True)
  
    sleep(5)
    
    V.autocoolsmall77.Wait()
    V.autocoolsmall77.Click(yoffset = 30,nosay = True)
    V.autocooldown.Click(nosay = True)

    sleep(5)
    try:
        V.autocoolsmall76.Wait()
    except Exception as e:
        print(e)
        V.autocoolsmall77.Wait()
        V.autocoolsmall77.Click(yoffset = 30,nosay = True)
        V.autocooldown.Click(nosay = True)
        V.autocoolsmall76.Wait()
        
    
    Say("Cool is on seventy six")  
    
    
    

    
    
    
    
    
    
    
    
    #Fan
    
    V.fanmode.Click(yoffset = 70,nosay = True)
    try:
        V.fanmodeon3.Click(nosay = True)
    except:
        V.fanmode.Click(yoffset = 70,nosay = True)
        V.fanmodeon3.Click(nosay = True)
        
    sleep(2)

    V.fanmodeissettoon.Wait()
    Say("fan is on")
   
      
    
    Say("Scheduling Page looks good") 
    Say("Going to the heat cool history page")
    V.climatehistorypageicon.Click()
    
    sleep(10)
    V.heatcooltopbar.SetThreshold(.87)
    V.heatcooltopbar.Wait()
    Say("Heat Cool History Page looks good")
    
 
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    

    if 'Android' not in V.Platform:
            Say("Opening the Viewer")
            V.CloseAndClean()
    else:
            pass       
    C.Reset()
    Say("Climate Test Passed")
    
    
    


main()