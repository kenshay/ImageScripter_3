import cv2
import numpy as np
from matplotlib import pyplot as plt
import os
from shutil import copyfile
import shutil, errno
import time
from paths import *
def copyanything(src, dst):
    try:
        shutil.copytree(src, dst)
    except OSError as exc: # python >2.5
        if exc.errno == errno.ENOTDIR:
            shutil.copy(src, dst)
        else: raise

Comparison_Pictures_Path = r"C:\Settings\Comparison_Pictures"

os.chdir(Comparison_Pictures_Path)

blue_image = cv2.imread(ImageScripter_Location + r"Data\bluescreen.png",0)

List_of_Blue_Pics = []

for img_in_file in os.listdir():
    try:
        img_in_file = os.path.abspath(img_in_file)
        max_val = 0
        #print('Image_Name = ',img_in_file)
        template = cv2.imread(img_in_file,0)
        copyfile(img_in_file, r"C:\Settings\Last_Templet_Image.png")
        w, h = template.shape[::-1]
        method =  cv2.TM_CCOEFF_NORMED
        # Apply template Matching
        res = cv2.matchTemplate(blue_image,template,method)
        min_val, max_val, min_loc, max_loc = cv2.minMaxLoc(res)
        if max_val >= .90:
            #print('Found Match -> ',img_in_file,' ',max_val)
            List_of_Blue_Pics.append(img_in_file)
            print(List_of_Blue_Pics)
        else:
            print('No match -> ',img_in_file)
    except Exception as e:
        print(e)

if List_of_Blue_Pics != []:
    MainPic = List_of_Blue_Pics[0]
    Desktop = os.path.join(os.environ["HOMEPATH"], "Desktop")
    epoch_time = str(int(time.time()))
    Destination_folder = Desktop + '\\Blue_Screen_Errors' + epoch_time + '\\'
    print(Destination_folder)
    copyfile(MainPic,r"C:\Settings\Last_Templet_Image.png")
    copyanything(Comparison_Pictures_Path,Destination_folder)
    Error = "Blue Screen Found, " + Destination_folder
    raise ValueError(Error)
else:
    print('No Blue Screen this cycle')
