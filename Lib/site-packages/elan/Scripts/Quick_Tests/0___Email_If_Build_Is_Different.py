import csv
import filecmp
import os
import shutil
from time import sleep
from paths import *

try:

    ##rCElan_Toolslast_buildtxt = r"C:\Elan_Tools\last_build.txt"



    with open(rCElan_Toolslast_buildtxt, 'r') as f:
        Old_Build_Name = f.read()
except:
    Old_Build_Name = 'Unknown'

def get_size(start_path = '.'):
    total_size = 0
    for dirpath, dirnames, filenames in os.walk(start_path):
        for f in filenames:
            fp = os.path.join(dirpath, f)
            total_size += os.path.getsize(fp)
    return total_size

def compare(folder1, folder2, output,Build_Name,output_txt=False, output_csv=False):
    report = _recursive_dircmp(folder1, folder2)
    folder1 = folder1.replace('\\', '/')
    folder2 = folder2.replace('\\', '/')
    os.chdir(output)
    if output_txt:
        _write_to_plain_text(folder1, folder2, output, report,Build_Name)
    if output_csv:
        _write_to_csv(folder1, folder2, output, report)
def _recursive_dircmp(folder1, folder2, prefix='.'):
    """Return a recursive dircmp comparison report as a dictionary."""

    comparison = filecmp.dircmp(folder1, folder2)

    data = {
        'left': [r'{}/{}'.format(prefix, i) for i in comparison.left_only],
        'right': [r'{}/{}'.format(prefix, i) for i in comparison.right_only],
        'both': [r'{}/{}'.format(prefix, i) for i in comparison.common_files],
    }

    for datalist in data.values():
        datalist.sort()

    if comparison.common_dirs:
        for folder in comparison.common_dirs:
            # Update prefix to include new sub_folder
            prefix += '/' + folder

            # Compare common folder and add results to the report
            sub_folder1 = os.path.join(folder1, folder)
            sub_folder2 = os.path.join(folder2, folder)
            sub_report = _recursive_dircmp(sub_folder1, sub_folder2, prefix)

            # Add results from sub_report to main report
            for key, value in sub_report.items():
                data[key] += value

    return data
def _write_to_plain_text(folder1, folder2, output, report,Build_Name):

    filename = Outputoutputtxt11
    with open(filename, 'w') as file:
        #file.write('COMPARISON OF FILES BETWEEN FOLDERS:\n')
        #file.write('\tFOLDER 1: {}\n'.format(folder1))
        #file.write('\tFOLDER 2: {}\n'.format(folder2))
        file.write('\n\n\n')

        file.write('FILES ONLY IN: {' + Build_Name + '}\n')
        #file.write('FILES ONLY IN: {}\n'.format(folder1))
        for item in report['left']:
            file.write('\t' + item + '\n')
        if not report['left']:
            file.write('\tNone\n')
        file.write('\n\n')

        file.write('FILES ONLY IN: {' + Old_Build_Name + '}\n')
        for item in report['right']:
            file.write('\t' + item + '\n')
        if not report['right']:
            file.write('\tNone\n')
        file.write('\n\n')



        '''
        file.write('FILES IN BOTH FOLDERS:\n')
        for item in report['both']:
            file.write('\t' + item + '\n')
        if not report['both']:
            file.write('\tNone\n')
        '''
def _write_to_csv(folder1, folder2, output, report):
    """Write the comparison report to a CSV file for use in Excel."""
    ##filename = 'C:\Output\output' + '.csv'
    filename = COutputoutputcsv
    #filename = output + '.csv'
    with open(filename, 'w') as file:
        csv_writer = csv.writer(file, dialect='excel', lineterminator='\r')

        # Write header data to the first row
        headers = (
            "Files only in folder '{}'".format(folder1),
            "Files only in folder '{}'".format(folder2),
            "Files in both folders",
        )
        csv_writer.writerow(headers)

        # Order report data to match with headers
        data = (
            report['left'],
            report['right'],
            report['both'],
        )

        # Write comparison data row by row to the CSV
        row_index = 0
        row_max = max(len(column) for column in data)
        while row_index < row_max:
            values = []
            for column in data:
                # Use data from column if it exists, otherwise use None
                try:
                    values += [column[row_index]]
                except IndexError:
                    values += [None]

            csv_writer.writerow(values)
            row_index += 1
print('Doing Compare')
##shutil.rmtree(r"C:\Output", ignore_errors=True)
shutil.rmtree(C123123Output, ignore_errors=True)
##os.makedirs(r"C:\Output")
os.makedirs(C123123Output)

if not os.path.exists(COld_Build):
    os.makedirs(COld_Build)
#if not os.path.exists(r"C:\Old_Build"):
#   os.makedirs(r"C:\Old_Build")

##shutil.rmtree(r"C:\New_Build", ignore_errors=True)
shutil.rmtree(rCNew_Build, ignore_errors=True)

def Get_Full_Path_OF_Build():
    ##Build_Folder = r"\\172.16.43.21\nas\Cloud_Drive\Elan_Builds"
    #Build_Folder = r"C:\Elan_Tools\Cloud_Drive\Elan_Builds"
    Build_Name = os.listdir(Build_Folder)[0]
    os.chdir(Build_Folder)
    Build_Full_Path = os.path.abspath(Build_Name)
    print(Build_Full_Path)
    return Build_Full_Path,Build_Name

for i in range(1000):
    try:
        Build_Full_Path,Build_Name= Get_Full_Path_OF_Build()
        break
    except Exception as e:
        print(e)
        print('sleep 213')
        sleep(1)
        
        
print("Build Name -> " + Build_Name)
##os.chdir(r"C:\Program Files\7-Zip")
os.chdir(CProgramFiles7Zip)
##os.system("7z x " + Build_Full_Path + " -oc:\\New_Build -r -y")
os.system("7z x " + Build_Full_Path + ocNew_Buildry)


print('Doing Compare')
#######################################Comparison



#folder1 = r"C:\New_Build"
folder1 = rCNew_Build
#folder2 = r"C:\Old_Build"
folder2 = COld_Build
##output = r"C:\\"
output = outputrC
##############################################Size

folder_1_size = get_size(folder1)
total_1 = 0
for root, dirs, files in os.walk(folder1):
    total_1 += len(files)


folder_2_size = get_size(folder2)
total_2 = 0
for root, dirs, files in os.walk(folder2):
    total_2 += len(files)

print('Folder 1 Size = ',folder_1_size)
print('Total Files = ',total_1)
print('Folder 2 Size = ',folder_2_size)
print('Total 2 Files Size = ',total_2)

if folder_1_size != folder_2_size or total_1 != total_2:
    compare(folder1, folder2, output,Build_Name, output_txt=True, output_csv=True)
    ##shutil.rmtree(r"C:\Old_Build", ignore_errors=True)
    shutil.rmtree(COld_Build, ignore_errors=True)
    Pass = False
    for i in range(10):
        try:
            ##os.rename(r"C:\New_Build", r"C:\Old_Build")
            os.rename(rCNew_Build, COld_Build)
            Pass = True
            break
        except Exception as e:
            print(e)
            sleep(1)
    if Pass == False:
        raise ValueError("Cant Rename")

    with open(Outputoutputtxt,'r') as f:
        text = f.read()
    ##with open(r"C:\Output\output.txt",'r') as f:
    ##    text = f.read()

    raise ValueError(text)
else:
    pass


##with open(r"C:\Elan_Tools\last_build.txt",'w') as f:
##    f.write(Build_Name)
with open(rCElan_Toolslast_buildtxt,'w') as f:
    f.write(Build_Name)











print('Finished')