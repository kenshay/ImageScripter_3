from imagescripter.core.device import Device_Class
import paramiko
from scp import SCPClient
from PIL import Image
from paths import *



class Mac_Class(Device_Class):
    def _click_(self, x, y):
        print("_click_")
        nbytes = 4096
        #command = "python3 Desktop/click.py #X #Y"
        command = "python Desktop/click.py #X #Y"
        command = command.replace('#X', str(x))
        command = command.replace('#Y', str(y))


        def createSSHClient():
            client = paramiko.SSHClient()
            client.load_system_host_keys()
            client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            client.connect(self._ipadress_, self._port_, self._username_, self._password_)
            return client

        client = paramiko.Transport((self._ipadress_, self._port_))
        client.connect(username=self._username_, password=self._password_)
        stdout_data = []
        stderr_data = []
        session = client.open_channel(kind='session')
        session.exec_command(command)
        while True:
            if session.recv_ready():
                stdout_data.append(session.recv(nbytes))
                print(stdout_data)
            if session.recv_stderr_ready():
                stderr_data.append(session.recv_stderr(nbytes))
                print(stderr_data)
            if session.exit_status_ready():
                break
        session.close()
        client.close()
        print("_click_")
    def _get_image_of_screen_(self,attempts = 100):
        def createSSHClient():
            client = paramiko.SSHClient()
            client.load_system_host_keys()
            client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            client.connect(self._ipadress_, self._port_, self._username_, self._password_)
            return client
        for atime in range(attempts):  # Should run only once, unless failure
            try:
                nbytes = 4096
                command = 'screencapture ~/Desktop/capture.png'
                client = paramiko.Transport((self._ipadress_, self._port_))
                client.connect(username=self._username_, password=self._password_)
                stdout_data = []
                stderr_data = []
                session = client.open_channel(kind='session')
                session.exec_command(command)
                while True:
                    if session.recv_ready():
                        stdout_data.append(session.recv(nbytes))
                    if session.recv_stderr_ready():
                        stderr_data.append(session.recv_stderr(nbytes))
                    if session.exit_status_ready():
                        break
                # print 'exit status: ', session.recv_exit_status()
                # print ''.join(stdout_data)
                # print ''.join(stderr_data)
                session.close()
                client.close()
                ssh = createSSHClient()
                scp = SCPClient(ssh.get_transport())
                scp.get('~/Desktop/capture.png', screenshot_file_MAC)
                break
            except PermissionError as e:
                print(e)
        return screenshot_file_MAC


if __name__ == "__main__":
    Interface = Mac_Class(ip_address='192.168.0.119', port=22, user_name='Ken', password='100hoods')
    actual_img_path = Interface._get_image_of_screen_()
    target_img_path = r"C:\ImageScripter_2\Lib\site-packages\elan\Applications_And_Devices\Mac\media.png"
    x, y = Interface._get_location_of_image_in_image(target_img_path, actual_img_path)
    print(x,y)
    Interface._click_(x, y)


