from importlib import reload
import traceback
from imagescripter.core.screen_recorder import Screen_Recorder_Class
import time
from threading import Thread
import os
import paramiko
import sys
from imagescripter.core.error_window import Error_Window_Self_Destruct_Class
from imagescripter.core.start_end_winow import Start_End_Window_Self_Destruct_Class
from imagescripter.core.variable_file_getter import Variable_File_Getter
from imagescripter.core.database_manager import Database_Manager_Class
#from imagescripter.core.ssh_manager_for_image_show import SSH_Manager_Class
from elan.ssh_manager import SSH_Manager_Class
import datetime
import base64



database_location = Variable_File_Getter.getVariableFromFile('Database_Location')

class ImageScripter_Script_Class():
    def __init__(self,script_location):
        self.script_location = script_location
        #Add to sys.path or wont run on import
        if os.path.dirname(os.path.dirname(self.script_location)) not in sys.path:
            sys.path.append(os.path.dirname(self.script_location))
        self.file_name = os.path.basename(self.script_location)
        print('Script File Name is -> ',self.file_name)
        self.file_name_without_py = self.file_name.replace('.py', '')
        self.Script_Name = self.file_name_without_py
        print('Script Name is -> ',self.file_name_without_py)
        self.Screen_Recorder = Screen_Recorder_Class()
        self.DataBase_Manager = Database_Manager_Class(database_location)
        self.has_run_once_already = False
        self.percent_of_memory_In_Use_end = 0
        self.percent_of_memory_In_Use_start = 0

        self.Controller_Name = Variable_File_Getter.getVariableFromFile('Controller_Name')
        self.Station_Name = Variable_File_Getter.getVariableFromFile('Station_Name')
        Controller_IP = Variable_File_Getter.getVariableFromFile('Controller_IP')
        Controller_Port = Variable_File_Getter.getVariableFromFile('Elan_Controller_Port')
        Controller_Port = int(Controller_Port)
        Controller_UserName = Variable_File_Getter.getVariableFromFile('Elan_Controller_User_Name')
        Controller_Password = Variable_File_Getter.getVariableFromFile('Elan_Controller_Password')
        self.SSH_Manager = SSH_Manager_Class(ipaddress=Controller_IP, port=Controller_Port, username=Controller_UserName, password=Controller_Password)

    def get_script_text(self):
        print('Getting Script Text From -> ',self.script_location)
        with open(self.script_location,'r') as f:
            script_text = f.read()
        return script_text



    def get_commands(self):
        with open(self.script_location) as f:
            commands = f.read()
        return commands

    def get_String_From_Image(self,path_of_image):
        with open(path_of_image, "rb") as imageFile:
            img_string = base64.b64encode(imageFile.read())
            print(img_string)
            return img_string

    def get_Image_From_String(self,string,path_of_image):
        imgdata = base64.b64decode(string)
        with open(path_of_image, 'wb') as f:
            f.write(imgdata)


    def get_and_enter_database_information_about_script(self):
        Client = 'Default'
        Index_Time = time.time()
        Index_Time_String = str(Index_Time)
        Script_Start_Time = self.Script_Start_time
        Steps = self.get_script_text()
        Date = self.Current_Date
        Script_End_Time = self.Script_End_time
        Script_Name = self.Script_Name
        Pass = self.did_Script_pass
        Fail = self.did_Script_fail
        Skip = 'N/A'
        #Controller_Name = Variable_File_Getter.getVariableFromFile('Controller_Name')
        #Station_Name = Variable_File_Getter.getVariableFromFile('Station_Name')
        Controller_Build = self.Controller_Build
        #Controller_Build = SSH_Manager.get_Build()

        Error = self.Last_Exception

        if Fail == 'True':
            Fail_Video = self.Pass_Or_Fail_Video
            Pass_Video = 'None'
            Last_Target_Image_Path = Variable_File_Getter.getVariableFromFile("Last_Target_Image_Location")
            Last_Templet_Image_Path = Variable_File_Getter.getVariableFromFile("Last_Templet_Image_Location")
            target_img = self.get_String_From_Image(Last_Target_Image_Path)
            templet_img = self.get_String_From_Image(Last_Templet_Image_Path)
        elif Pass == 'True':
            Fail_Video = 'None'
            Pass_Video = self.Pass_Or_Fail_Video
            target_img = 'None'
            templet_img = 'None'
        Memory_Used_Start = self.percent_of_memory_In_Use_start
        Memory_Used_End = self.percent_of_memory_In_Use_end
        Data = ''
        Error_ID = ''.join([i for i in Error if not i.isdigit()])
        self.DataBase_Manager.enter_results_into_database(Index_Time,Script_Start_Time, Steps, Date, Script_End_Time, Script_Name, Pass, Fail, Skip,self.Controller_Name,self.Station_Name, Controller_Build, Error, target_img, templet_img, Error_ID,Fail_Video,Pass_Video,Client,Index_Time_String,Memory_Used_Start,Memory_Used_End,Data)


    def update_controller_if_needed(self):
        try:
            import os
            from imagescripter.core.variable_file_getter import Variable_File_Getter
            try:
                Last_Controller_Build = Variable_File_Getter.getVariableFromFile('Last_Controler_Build_File_Name')
            except:
                Variable_File_Getter.setFileFromVariable('Last_Controler_Build_File_Name','')
                Last_Controller_Build = Variable_File_Getter.getVariableFromFile('Last_Controler_Build_File_Name')
            Controler_Build_Location = Variable_File_Getter.getVariableFromFile('Controler_Build_Location')
            last_dir = os.getcwd()
            Current_Build = os.listdir(Controler_Build_Location)[0]
            if Current_Build != Last_Controller_Build:
                print('Current Build is ',Current_Build,' Last Build is ',Last_Controller_Build)
                print("Updating Because Builds Are Different")
                from elan import Configurator
                Configurator.Update()
                Variable_File_Getter.setFileFromVariable('Last_Controler_Build_File_Name', Current_Build)
            else:
                print('Current Build is ',Current_Build,' Last Build is ',Last_Controller_Build)
                print("NOT Updating Because Builds Are NOT Different")
        except Exception as e:
            print(e)




    def set_Script_Start_time(self):
        now = datetime.datetime.now()
        hour_min = str(now.hour) + ':' + str(now.minute) + ':' + str(now.second)
        print('Set Scripts Start Time -> ',hour_min)
        #16:49:13
        self.Script_Start_time = hour_min


    def log_current_script_to_settings(self):
        Variable_File_Getter.setFileFromVariable('Current_Running_Script',self.Script_Name)




    def set_Script_End_time(self):
        now = datetime.datetime.now()
        self.Current_Date = str(now.month) + '/' + str(now.day) + '/' + str(now.year)
        # 2015 5 6 8 53 40
        hour_min = str(now.hour) + ':' + str(now.minute) + ':' + str(now.second)
        print('Set Scripts Start Time -> ',hour_min)
        #16:49:13
        self.Script_End_time = hour_min





    def run_simple(self):
        try:
            print("Running Script -> ", self.Script_Name)
            self.Screen_Recorder.record(self.file_name_without_py)
            module = __import__(self.file_name_without_py)
            self.Pass_Or_Fail_Video = self.Screen_Recorder.stop_simple()
        except Exception as e:
            self.Pass_Or_Fail_Video = self.Screen_Recorder.stop_simple()
            raise





















    def run(self):
        Encoded_Traceback = ' '
        self.has_run_once_already = True
        print('#####################################')
        print("Running Script -> ",self.Script_Name)
        print('#####################################')
        self.Fail_Video = 'None'
        self.Last_Exception = 'None'
        self.set_Script_Start_time()
        self.Screen_Recorder.record(self.file_name_without_py)
        try:
            self.percent_of_memory_In_Use_start = self.SSH_Manager.get_percent_of_memory_In_Use2()
            self.log_current_script_to_settings()
            Start_Window = Start_End_Window_Self_Destruct_Class()
            self.update_controller_if_needed()
            module = __import__(self.file_name_without_py)
            self.percent_of_memory_In_Use_end = self.SSH_Manager.get_percent_of_memory_In_Use2()
            self.has_run_once_already == True
            time.sleep(10)
            End_Window = Start_End_Window_Self_Destruct_Class()
            self.set_Script_End_time()
            self.PassOrFail = 'Pass'
            self.Controller_Build = self.SSH_Manager.get_Build()
            self.Pass_Or_Fail_Video = self.Screen_Recorder.stop(Station_Name=self.Station_Name, Script_Name=self.Script_Name, Build = self.Controller_Build,
                                      PassOrFail=self.PassOrFail, Error=Encoded_Traceback)
            self.did_Script_fail = 'False'
            self.did_Script_pass = 'True'
            self.get_and_enter_database_information_about_script()
        except Exception as e:
            self.percent_of_memory_In_Use_end = self.SSH_Manager.get_percent_of_memory_In_Use2()
            self.Last_Exception = traceback.format_exc()
            #########################
            Encoded_Traceback = self.Last_Exception.replace(" ", "")
            Encoded_Traceback = ''.join(e for e in Encoded_Traceback if e.isalnum())
            Last_Target_Image_Path = Variable_File_Getter.getVariableFromFile("Last_Target_Image_Location")
            Size = str(os.path.getsize(Last_Target_Image_Path))
            Encoded_Traceback += Size
            print('Encoded_Traceback -> ', Encoded_Traceback)
            ########################
            print("Exception 29")
            #time.sleep(5)
            Error_Window = Error_Window_Self_Destruct_Class(str(e))
            self.set_Script_End_time()
            self.PassOrFail = 'Fail'
            self.Controller_Build = self.SSH_Manager.get_Build()
            self.Pass_Or_Fail_Video = self.Screen_Recorder.stop(Station_Name=self.Station_Name, Script_Name=self.Script_Name,Build = self.Controller_Build, PassOrFail=self.PassOrFail,Error=Encoded_Traceback)
            self.did_Script_fail = 'True'
            self.did_Script_pass = 'False'
            self.get_and_enter_database_information_about_script()
            raise



    def re_run(self):

        Encoded_Traceback = None
        print('#####################################')
        print("RE-Running Script -> ",self.Script_Name)
        print('#####################################')
        self.Fail_Video = 'None'
        self.Last_Exception = 'None'
        self.set_Script_Start_time()
        self.Screen_Recorder.record(self.file_name_without_py)
        try:
            self.percent_of_memory_In_Use_start = self.SSH_Manager.get_percent_of_memory_In_Use2()
            self.log_current_script_to_settings()
            Start_Window = Start_End_Window_Self_Destruct_Class()
            self.update_controller_if_needed()
            module = __import__(self.file_name_without_py)
            reload(module)
            self.percent_of_memory_In_Use_end = self.SSH_Manager.get_percent_of_memory_In_Use2()
            time.sleep(10)
            End_Window = Start_End_Window_Self_Destruct_Class()
            self.set_Script_End_time()
            self.PassOrFail = 'Pass'
            self.Controller_Build = self.SSH_Manager.get_Build()
            self.Pass_Or_Fail_Video = self.Screen_Recorder.stop(Station_Name=self.Station_Name, Script_Name=self.Script_Name, Build = self.Controller_Build,
                                      PassOrFail=self.PassOrFail, Error=Encoded_Traceback)
            self.did_Script_fail = 'False'
            self.did_Script_pass = 'True'
            self.get_and_enter_database_information_about_script()
        except Exception as e:
            self.percent_of_memory_In_Use_end = self.SSH_Manager.get_percent_of_memory_In_Use2()
            self.Last_Exception = traceback.format_exc()
            #########################
            Encoded_Traceback = self.Last_Exception.replace(" ", "")
            Encoded_Traceback = ''.join(e for e in Encoded_Traceback if e.isalnum())
            Last_Target_Image_Path = Variable_File_Getter.getVariableFromFile("Last_Target_Image_Location")
            Size = str(os.path.getsize(Last_Target_Image_Path))
            Encoded_Traceback += Size
            print('Encoded_Traceback -> ', Encoded_Traceback)
            ########################
            Error_Window = Error_Window_Self_Destruct_Class(str(e))
            self.set_Script_End_time()
            self.PassOrFail = 'Fail'
            self.Controller_Build = self.SSH_Manager.get_Build()
            self.Pass_Or_Fail_Video = self.Screen_Recorder.stop(Station_Name = self.Station_Name,Script_Name = self.Script_Name,Build = self.Controller_Build,PassOrFail = self.PassOrFail,Error = Encoded_Traceback)
            self.did_Script_fail = 'True'
            self.did_Script_pass = 'False'
            self.get_and_enter_database_information_about_script()
            raise







            #os.system()
        #try:
        #    exec(self.get_commands())
        #except Exception as e:
        #    print(e)
        #    raise
        #    #return Exception


if __name__ == "__main__":

    try:
        with open(r"C:\Settings\script_runner_script_path.txt",'r') as f:
            path = f.read()
    except:
        with open(r"C:\Settings\script_runner_script_path.txt",'w') as f:
            f.write('')

    if path != '':
        #script_location = r"C:\Elan_Tools\ImageScripter\ProgramData\SystemFiles\Python\Lib\site-packages\elan\Pools\Frank\4_media.py"
        #script_location = r"C:\ImageScripter_2\Lib\site-packages\elan\Scripts\Test\fail.py"
        #script_location = r"C:\ImageScripter_2\Lib\site-packages\elan\Scripts\Quick_Tests\8_____Check_Network_Scanner___.py"
        #script_location = r"C:\ImageScripter_2\Lib\site-packages\elan\Scripts\FrankReal\0b_Full_Backup_Only_On_Saturday.py"
        script = ImageScripter_Script_Class(path)
        script.run()